<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerPlus Dashboard - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; }
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .filter-btn { transition: all 0.2s; cursor: pointer; }
        .filter-btn.active { background: #6366f1; color: white; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #f3f4f6; }
        .sortable.asc::after { content: ' ‚Üë'; }
        .sortable.desc::after { content: ' ‚Üì'; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 1rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; }
        input, select { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-top: 0.5rem; }
        input:focus, select:focus { outline: none; border-color: #6366f1; }
        .btn-primary { background: #6366f1; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-success { background: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-edit { background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-danger { background: #ef4444; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
        .stage-prospect    { background: #9CA3AF; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; }
        .stage-contacted   { background: #60A5FA; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; }
        .stage-qualified   { background: #2563EB; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; }
        .stage-meeting     { background: #7C3AED; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; }
        .stage-proposal    { background: #F59E0B; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; }
        .stage-negotiation { background: #EF4444; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; }
        .stage-dealwon     { background: #10B981; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-6 px-8 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">PowerPlus Dashboard</h1>
                <p class="text-indigo-200 mt-1">German Market Director - Ultimate Edition</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-indigo-200">Last Update</p>
                <p class="text-lg font-semibold" id="lastUpdate">-</p>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-8">
            <div class="flex gap-1 overflow-x-auto py-2">
                <button onclick="switchTab('overview')" id="tab-overview" class="filter-btn active px-6 py-3 rounded-lg font-semibold">üìä Overview</button>
                <button onclick="switchTab('pipeline')" id="tab-pipeline" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">üéØ Pipeline</button>
                <button onclick="switchTab('employers')" id="tab-employers" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">ü§ù Employers</button>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="max-w-7xl mx-auto px-8 py-6">

        <!-- Overview -->
        <div id="content-overview" class="tab-content">
            <p class="text-xl text-gray-600">√úbersicht wird geladen...</p>
        </div>

        <!-- Pipeline -->
        <div id="content-pipeline" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Sales Pipeline</h2>
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="filterPipeline('all')" id="filter-all" class="filter-btn active px-4 py-2 rounded bg-indigo-600 text-white">All</button>
                        <button onclick="filterPipeline('Pflege')" id="filter-Pflege" class="filter-btn px-4 py-2 rounded bg-gray-100">Pflege</button>
                        <button onclick="filterPipeline('Handwerk')" id="filter-Handwerk" class="filter-btn px-4 py-2 rounded bg-gray-100">Handwerk</button>
                        <button onclick="filterPipeline('Gastro')" id="filter-Gastro" class="filter-btn px-4 py-2 rounded bg-gray-100">Gastro</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-max">
                        <thead id="pipeline-thead"></thead>
                        <tbody id="pipeline-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Employers (Beispiel) -->
        <div id="content-employers" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Employers</h2>
                <p>Daten werden geladen...</p>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA1WKOUlVF1YvBMolSVACHOXz2kGQ_a6Sc",
            authDomain: "powerplus-dashboard.firebaseapp.com",
            projectId: "powerplus-dashboard",
            storageBucket: "powerplus-dashboard.firebasestorage.app",
            messagingSenderId: "506858654374",
            appId: "1:506858654374:web:06e47ff0cd5f8ae7808267",
            measurementId: "G-H1BJQBB3KP"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allData = { pipeline: [] };
        let filterBranch = 'all';

        const stageColors = {
            'Prospect': 'stage-prospect',
            'Contacted': 'stage-contacted',
            'Qualified': 'stage-qualified',
            'Meeting': 'stage-meeting',
            'Proposal': 'stage-proposal',
            'Negotiation': 'stage-negotiation',
            'Deal Won': 'stage-dealwon'
        };

        function loadPipeline() {
            db.collection('pipeline').onSnapshot(snapshot => {
                allData.pipeline = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPipeline();
            }, err => {
                console.error("Firestore-Fehler:", err);
                document.getElementById('pipeline-tbody').innerHTML = '<tr><td colspan="10" class="text-center py-8 text-red-600">Fehler beim Laden der Daten</td></tr>';
            });
        }

        function renderPipeline() {
            const thead = document.getElementById('pipeline-thead');
            const tbody = document.getElementById('pipeline-tbody');

            thead.innerHTML = `
                <tr class="bg-gray-100 text-left">
                    <th class="px-4 py-3 font-semibold">Company</th>
                    <th class="px-4 py-3 font-semibold">Branch</th>
                    <th class="px-4 py-3 font-semibold">Stage</th>
                </tr>
            `;

            let html = '';
            let filtered = allData.pipeline;
            if (filterBranch !== 'all') {
                filtered = filtered.filter(item => item.Branch === filterBranch);
            }

            if (filtered.length === 0) {
                html = '<tr><td colspan="3" class="text-center py-12 text-gray-500">Keine Eintr√§ge gefunden</td></tr>';
            } else {
                filtered.forEach(item => {
                    const stageClass = stageColors[item.Stage] || 'bg-gray-200 text-gray-800';
                    const stageDisplay = item.Stage ? `<span class="${stageClass}">${item.Stage}</span>` : '-';
                    html += `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-4 py-3">${item.Company || '-'}</td>
                            <td class="px-4 py-3">${item.Branch || '-'}</td>
                            <td class="px-4 py-3">${stageDisplay}</td>
                        </tr>
                    `;
                });
            }
            tbody.innerHTML = html;

            // Last Update
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('de-DE');
        }

        function filterPipeline(branch) {
            filterBranch = branch;
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.toggle('active', btn.id === 'filter-' + branch);
                btn.classList.toggle('bg-indigo-600', btn.id === 'filter-' + branch);
                btn.classList.toggle('text-white', btn.id === 'filter-' + branch);
                btn.classList.toggle('bg-gray-100', btn.id !== 'filter-' + branch);
            });
            renderPipeline();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('content-' + tab).classList.remove('hidden');

            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            document.getElementById('tab-' + tab).classList.add('active', 'bg-indigo-600', 'text-white');
            document.getElementById('tab-' + tab).classList.remove('bg-gray-100');
        }

        // Start
        window.onload = () => {
            loadPipeline();
            switchTab('pipeline');  // direkt Pipeline zeigen, da das dein Hauptproblem ist
        };
    </script>
</body>
</html>
