<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PowerPlus Dashboard - Ultimate Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<style>
    .metric-card { transition: all 0.3s ease; }
    .metric-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
    .filter-btn { transition: all 0.2s; cursor: pointer; }
    .filter-btn.active { background: #6366f1; color: white; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .badge-green { background: #d1fae5; color: #065f46; }
    .badge-yellow { background: #fef3c7; color: #92400e; }
    .badge-blue { background: #dbeafe; color: #1d4ed8; }
    .badge-red { background: #fee2e2; color: #991b1b; }
    .badge-purple { background: #ede9fe; color: #5b21b6; }
    .stage-badge { padding: 2px 6px; border-radius: 0.375rem; color: white; font-weight: 600; display: inline-block; }
    .stage-Prospect { background: #9CA3AF; }
    .stage-Contacted { background: #60A5FA; }
    .stage-Qualified { background: #2563EB; }
    .stage-Meeting { background: #7C3AED; }
    .stage-Proposal { background: #F59E0B; }
    .stage-Negotiation { background: #EF4444; }
    .stage-Deal\ Won { background: #10B981; }
    .sortable { cursor: grab; user-select: none; }
    .sortable:hover { background: #f3f4f6; }
    .sort-arrow { display: inline-block; margin-left: 4px; opacity: 0.3; }
    .sortable.asc .sort-arrow { opacity: 1; transform: rotate(0deg); }
    .sortable.desc .sort-arrow { opacity: 1; transform: rotate(180deg); }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 1rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; }
    input, select, textarea { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-top: 0.5rem; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #6366f1; }
    textarea { min-height: 80px; }
    .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(99,102,241,0.3); }
    .btn-secondary { background: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-danger { background: #ef4444; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
    .btn-danger:hover { background: #dc2626; }
    .btn-edit { background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
    .btn-edit:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
    .btn-success:hover { background: #059669; }
    .action-bar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .column-list { max-height: 300px; overflow-y: auto; }
    .column-item { padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
</style>
</head>
<body class="bg-gray-50">
<!-- Header + Tabs + Content wie bisher … -->

<!-- Für die Umsetzung hier beschränke ich mich auf die wichtigsten JS-Funktionen, die Bulk Edit, Stage Farben, Drag & Drop und Deal Won abdecken -->

<script>
const stages = [
    {name: 'Prospect', color: '#9CA3AF'},
    {name: 'Contacted', color: '#60A5FA'},
    {name: 'Qualified', color: '#2563EB'},
    {name: 'Meeting', color: '#7C3AED'},
    {name: 'Proposal', color: '#F59E0B'},
    {name: 'Negotiation', color: '#EF4444'},
    {name: 'Deal Won', color: '#10B981'}
];

let selectedPipelineItems = [];
let columnConfig = JSON.parse(localStorage.getItem('columnConfig')) || {
    pipeline: ['Company','Branch','Region','Stage','Priority','Azubi Bedarf','Phone','Last Contacted'],
    employers: ['Company','Branch','Trust Score','Phone','Current PowerPlus Workers','Notes']
};

// Render Pipeline table
function renderPipeline() {
    const tbody = document.getElementById('pipeline-tbody');
    tbody.innerHTML = '';
    allData.pipeline.forEach(item => {
        const checked = selectedPipelineItems.includes(item.id) ? 'checked' : '';
        let row = `<tr onclick="togglePipelineSelection('${item.id}')">
        <td><input type="checkbox" ${checked} onclick="event.stopPropagation(); togglePipelineSelection('${item.id}')"></td>`;
        columnConfig.pipeline.forEach(col => {
            if(col === 'Stage'){
                let options = stages.map(s => `<option value="${s.name}" ${item.Stage===s.name?'selected':''}>${s.name}</option>`).join('');
                row += `<td><select onchange="updateStage('${item.id}', this.value)">${options}</select></td>`;
            }else{
                row += `<td>${item[col]||'-'}</td>`;
            }
        });
        row += '</tr>';
        tbody.innerHTML += row;
    });
}

// Toggle selection
function togglePipelineSelection(id){
    const idx = selectedPipelineItems.indexOf(id);
    if(idx>-1) selectedPipelineItems.splice(idx,1);
    else selectedPipelineItems.push(id);
}

// Bulk Edit Stage
function bulkEditPipeline(){
    if(selectedPipelineItems.length===0) {alert('Select at least one item'); return;}
    const newStage = prompt('Enter new Stage (Prospect, Contacted, Qualified, Meeting, Proposal, Negotiation, Deal Won)');
    if(!stages.map(s=>s.name).includes(newStage)) {alert('Invalid Stage'); return;}
    selectedPipelineItems.forEach(id=>{
        const item = allData.pipeline.find(p=>p.id===id);
        if(item){
            item.Stage = newStage;
            // Deal Won → move to Employers
            if(newStage==='Deal Won'){
                const emp = {
                    id:'emp_'+Date.now(),
                    Company:item.Company,
                    Branch:item.Branch,
                    'Trust Score':'',
                    Phone:item.Phone,
                    'Current PowerPlus Workers':'',
                    Notes:''
                };
                allData.employers.push(emp);
                renderEmployers();
            }
        }
    });
    renderPipeline();
}

// Update Stage from dropdown
function updateStage(id,value){
    const item = allData.pipeline.find(p=>p.id===id);
    if(item){
        item.Stage = value;
        if(value==='Deal Won'){
            const emp = {
                id:'emp_'+Date.now(),
                Company:item.Company,
                Branch:item.Branch,
                'Trust Score':'',
                Phone:item.Phone,
                'Current PowerPlus Workers':'',
                Notes:''
            };
            allData.employers.push(emp);
            renderEmployers();
        }
    }
    renderPipeline();
}

// Drag & Drop Columns
function initColumnDrag(){
    const list = document.getElementById('column-list');
    let dragSrcEl = null;
    list.querySelectorAll('.column-item').forEach(item=>{
        item.setAttribute('draggable','true');
        item.addEventListener('dragstart', e=>{dragSrcEl=item;e.dataTransfer.effectAllowed='move';});
        item.addEventListener('dragover', e=>{e.preventDefault();});
        item.addEventListener('drop', e=>{
            e.preventDefault();
            if(dragSrcEl!==item){
                const from = Array.from(list.children).indexOf(dragSrcEl);
                const to = Array.from(list.children).indexOf(item);
                const arr = columnConfig['pipeline'];
                const moved = arr.splice(from,1)[0];
                arr.splice(to,0,moved);
                saveColumnsConfig();
                renderPipeline();
                renderColumnList('pipeline');
            }
        });
    });
}
function saveColumnsConfig(){localStorage.setItem('columnConfig',JSON.stringify(columnConfig));}

// Dummy renderEmployers für Vollständigkeit
function renderEmployers(){
    const tbody = document.getElementById('employers-tbody');
    tbody.innerHTML='';
    allData.employers.forEach(emp=>{
        let row=`<tr>`;
        columnConfig.employers.forEach(col=>{row+=`<td>${emp[col]||'-'}</td>`});
        row+='</tr>';tbody.innerHTML+=row;
    });
}

// Beispiel: allData initial
let allData={pipeline:[{id:'1',Company:'Firma A',Branch:'Pflege',Region:'Nord',Stage:'Prospect',Priority:'High','Azubi Bedarf':2,Phone:'012345','Last Contacted':'2026-01-01'}],employers:[]};
renderPipeline();
renderEmployers();
</script>
</body>
</html>
