<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerPlus Dashboard - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <style>
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .filter-btn { transition: all 0.2s; cursor: pointer; }
        .filter-btn.active { background: #6366f1; color: white; }
        .badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-blue { background: #dbeafe; color: #1d4ed8; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        
        .badge-purple { background: #ede9fe; color: #5b21b6; }
        
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 9999px; overflow: hidden; width: 120px; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #10b981, #34d399); transition: width 0.5s ease-in-out; }
        
        .trust-score { padding: 4px 12px; border-radius: 9999px; font-weight: 600; display: inline-block; }
        .trust-1 { background: #fee2e2; color: #991b1b; }
        .trust-2 { background: #fed7aa; color: #9a3412; }
        .trust-3 { background: #fef3c7; color: #92400e; }
        .trust-4 { background: #d1fae5; color: #065f46; }
        .trust-5 { background: #a7f3d0; color: #064e3b; }
        
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #f3f4f6; }
        .sort-arrow { display: inline-block; margin-left: 4px; opacity: 0.3; }
        .sortable.asc .sort-arrow { opacity: 1; transform: rotate(0deg); }
        .sortable.desc .sort-arrow { opacity: 1; transform: rotate(180deg); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 1rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; }
        
        input, select, textarea { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-top: 0.5rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #6366f1; }
        textarea { min-height: 80px; }
        
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(99,102,241,0.3); }
        .btn-secondary { background: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-danger { background: #ef4444; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
        .btn-danger:hover { background: #dc2626; }
        .btn-edit { background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-edit:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
        .btn-success:hover { background: #059669; }
        
        .action-bar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .action-bar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .action-bar .filters { display: flex; gap: 0.5rem; align-items:center; }
        .action-bar .actions { margin-left: auto; display: flex; gap: 0.5rem; align-items:center; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem; }
        .search-input { width: 220px; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
        
        .column-list { max-height: 300px; overflow-y: auto; }
        .column-item { padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .chart-box { height: 320px; max-height: 360px; }
        .debug-panel { position: fixed; right: 12px; bottom: 12px; width: 360px; max-height: 40vh; overflow:auto; background: rgba(17,24,39,0.95); color: #fff; padding: 0.75rem; border-radius: 0.5rem; font-size: 12px; z-index: 1200; box-shadow: 0 10px 30px rgba(2,6,23,0.6); }
        .debug-panel h4 { margin: 0 0 6px 0; font-size: 13px; }
        .debug-toggle { position: fixed; right: 12px; bottom: 12px; z-index: 1300; }
        .snackbar { position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; background: rgba(17,24,39,0.95); color: #fff; padding: 10px 14px; border-radius: 8px; display: none; z-index: 1400; box-shadow: 0 8px 24px rgba(2,6,23,0.6); align-items: center; gap: 12px; }
        .snackbar button { background: transparent; border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
        .snackbar .msg { font-size: 13px; }
        /* Metric detail styling */
        .metric-detail-positive { color: #10b981; font-weight:700; }
        .metric-detail-negative { color: #ef4444; font-weight:700; }
        .metric-small { font-size: 12px; color: #6b7280; }
        /* Month chips */
        .month-chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        .month-chip { padding:6px 10px; border-radius:9999px; background:#f3f4f6; cursor:pointer; font-size:13px; border:1px solid transparent; }
        .month-chip.active { background:#6366f1; color:#fff; border-color:#4f46e5; }
        /* Inline edit */
        .inline-edit { position:relative; display:flex; align-items:center; gap:8px; }
        .inline-edit .value { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; display:inline-block; padding-right:28px; }
        .inline-edit .edit-btn { position:absolute; right:6px; top:50%; transform:translateY(-50%); background:transparent; border:none; cursor:pointer; color:#6b7280; padding:4px; opacity:0; transition:opacity .12s ease; font-size:14px; }
        .inline-edit:hover .edit-btn { opacity:0.95; }
        .inline-edit .inline-input { padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px; }
        .row-info-btn { background:transparent; border:none; cursor:pointer; color:#6b7280; padding:6px; border-radius:6px; opacity:0; transition: opacity 0.12s ease; }
        tr:hover .row-info-btn { opacity:1; }
        .row-popover { position:fixed; z-index:1600; background:white; color:#0f172a; padding:14px; border-radius:8px; box-shadow:0 8px 24px rgba(2,6,23,0.12); border:1px solid #e6edf3; display:none; min-width:280px; max-width:360px; }
        .row-popover h4 { margin:0 0 8px 0; font-size:14px; }
        .row-popover h4 { cursor: grab; }
        .row-popover .close-btn { position:absolute; right:8px; top:6px; background:transparent; border:none; cursor:pointer; color:#9CA3AF; }
        .row-popover .pop-edit-btn { position:absolute; right:36px; top:6px; background:transparent; border:none; cursor:pointer; color:#6b7280; padding:4px; border-radius:4px; }
        .header-edit { margin-left:8px; background:transparent; border:none; cursor:pointer; color:#6b7280; font-size:12px; padding:2px 6px; border-radius:4px; }
        .header-edit:hover { background:#f3f4f6; }
        .row-popover a { color:#0369a1; text-decoration:underline; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-6 px-8 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">PowerPlus Dashboard</h1>
                <p class="text-indigo-200 mt-1">German Market Director - Ultimate Edition</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-indigo-200">Last Update</p>
                <p class="text-lg font-semibold" id="lastUpdate">-</p>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-8">
            <div class="flex gap-1 overflow-x-auto py-2">
                <button onclick="switchTab('overview')" id="tab-overview" class="filter-btn active px-6 py-3 rounded-lg font-semibold whitespace-nowrap">üìä Overview</button>
                <button onclick="switchTab('pipeline')" id="tab-pipeline" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200 whitespace-nowrap">üéØ Pipeline</button>
                <button onclick="switchTab('candidates')" id="tab-candidates" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200 whitespace-nowrap">‚≠ê Candidates</button>
                <button onclick="switchTab('employers')" id="tab-employers" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200 whitespace-nowrap">ü§ù Employers</button>
                <button onclick="switchTab('placements')" id="tab-placements" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200 whitespace-nowrap">‚úÖ Placements</button>
                <button onclick="switchTab('risk')" id="tab-risk" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200 whitespace-nowrap">üõ°Ô∏è Risk</button>
                <button onclick="switchTab('market')" id="tab-market" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200 whitespace-nowrap">üó∫Ô∏è Market</button>
                <button onclick="switchTab('training')" id="tab-training" class="filter-btn px-6 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200 whitespace-nowrap">üìö Training</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-8 py-6">
        
        <!-- OVERVIEW TAB -->
        <div id="content-overview" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Placements This Month</p>
                            <p class="text-3xl font-bold text-indigo-600" id="metric-placements-month">0</p>
                            <div class="text-sm text-gray-500 mt-1" id="metric-placements-change">‚Äî</div>
                            <div class="text-xs text-gray-500 mt-1" id="metric-placements-target">Target: 10/month (<span id="metric-placements-target-percent">0%</span>)</div>
                        </div>
                        <div class="bg-indigo-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex items-center text-sm">
                        <span class="text-gray-600">Target: 10/month</span>
                    </div>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="metric-placements-bar" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Active Pipeline</p>
                            <p class="text-3xl font-bold text-blue-600" id="metric-pipeline">0</p>
                            <div class="text-sm text-gray-500 mt-1" id="metric-pipeline-details">‚Äî</div>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Available Candidates</p>
                            <p class="text-3xl font-bold text-green-600" id="metric-candidates">0</p>
                            <div class="text-sm text-gray-500 mt-1" id="metric-candidates-details">‚Äî</div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-gray-600">High Risk Items</p>
                            <p class="text-3xl font-bold text-red-600" id="metric-risk">0</p>
                            <div class="text-sm text-gray-500 mt-1" id="metric-employers-avg-trust">Avg Trust Score: ‚Äî</div>
                            <div class="text-sm text-gray-500 mt-1" id="metric-employers-active">Active Partners: ‚Äî | High Engagement: ‚Äî</div>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6 chart-box">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Placements 2026</h3>
                        <div class="flex gap-2">
                                <!-- range buttons removed; showing fixed 12 months from Jan 2026 -->
                                <button id="placements-bar-btn" onclick="togglePlacementsChart('bar')" class="btn-secondary text-sm">Bar</button>
                                <button id="placements-line-btn" onclick="togglePlacementsChart('line')" class="btn-secondary text-sm">Line</button>
                            </div>
                    </div>
                    <canvas id="placementsMonthChart" height="320"></canvas>
                    <div id="placements-month-chips" class="month-chips"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 chart-box">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Pipeline by Stage</h3>
                    <canvas id="pipelineChart" height="250"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6 chart-box">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Candidates by Status</h3>
                    <canvas id="candidatesChart" height="250"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 chart-box">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Branch Distribution</h3>
                    <canvas id="branchChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- PIPELINE TAB -->
        <div id="content-pipeline" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Sales Pipeline</h2>
                    <div class="action-bar">
                        <div class="filters">
                            <div class="flex gap-2">
                                <button onclick="filterPipeline('all')" id="filter-pipeline-all" class="filter-btn active px-3 py-1 rounded-lg text-sm font-semibold">All</button>
                                <button onclick="filterPipeline('Pflege')" id="filter-pipeline-Pflege" class="filter-btn px-3 py-1 rounded-lg text-sm font-semibold bg-gray-100">Pflege</button>
                                <button onclick="filterPipeline('Handwerk')" id="filter-pipeline-Handwerk" class="filter-btn px-3 py-1 rounded-lg text-sm font-semibold bg-gray-100">Handwerk</button>
                                <button onclick="filterPipeline('Gastro')" id="filter-pipeline-Gastro" class="filter-btn px-3 py-1 rounded-lg text-sm font-semibold bg-gray-100">Gastro</button>
                            </div>
                            <input class="search-input" placeholder="Search pipeline..." oninput="setSearch('pipeline', this.value)">
                        </div>
                        <div class="actions">
                            <button onclick="manageColumns('pipeline')" class="btn-success btn-sm">‚öôÔ∏è</button>
                            <button onclick="openAddModal('pipeline')" class="btn-primary btn-sm">+ Add</button>
                            <button onclick="bulkEditPipeline()" class="btn-edit btn-sm">Edit</button>
                            <button onclick="bulkDeletePipeline()" class="btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="pipeline-table">
                        <thead id="pipeline-thead"></thead>
                        <tbody id="pipeline-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CANDIDATES TAB -->
        <div id="content-candidates" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Candidate Quality & Readiness</h2>
                    <div class="action-bar">
                        <div class="filters">
                            <div class="flex gap-2">
                                <button onclick="filterCandidates('all')" id="filter-candidates-all" class="filter-btn active px-3 py-1 rounded-lg text-sm font-semibold">All</button>
                                <button onclick="filterCandidates('Available')" id="filter-candidates-Available" class="filter-btn px-3 py-1 rounded-lg text-sm font-semibold bg-gray-100">Available</button>
                                <button onclick="filterCandidates('Training')" id="filter-candidates-Training" class="filter-btn px-3 py-1 rounded-lg text-sm font-semibold bg-gray-100">Training</button>
                                <button onclick="filterCandidates('Screening')" id="filter-candidates-Screening" class="filter-btn px-3 py-1 rounded-lg text-sm font-semibold bg-gray-100">Screening</button>
                            </div>
                            <input class="search-input" placeholder="Search candidates..." oninput="setSearch('candidates', this.value)">
                        </div>
                        <div class="actions">
                            <button onclick="manageColumns('candidates')" class="btn-success btn-sm">‚öôÔ∏è</button>
                            <button onclick="openAddModal('candidates')" class="btn-primary btn-sm">+ Add</button>
                            <button onclick="bulkEditCandidates()" class="btn-edit btn-sm">Edit</button>
                            <button onclick="bulkDeleteCandidates()" class="btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="candidates-table">
                        <thead id="candidates-thead"></thead>
                        <tbody id="candidates-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- EMPLOYERS TAB -->
        <div id="content-employers" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Employers</h2>
                    <div class="action-bar">
                        <div class="filters">
                            <input class="search-input" placeholder="Search employers..." oninput="setSearch('employers', this.value)">
                        </div>
                        <div class="actions">
                            <button onclick="manageColumns('employers')" class="btn-success btn-sm">‚öôÔ∏è</button>
                            <button onclick="openAddModal('employers')" class="btn-primary btn-sm">+ Add</button>
                            <button onclick="bulkEditEmployers()" class="btn-edit btn-sm">Edit</button>
                            <button onclick="bulkDeleteEmployers()" class="btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="employers-table">
                        <thead id="employers-thead"></thead>
                        <tbody id="employers-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PLACEMENTS TAB -->
        <div id="content-placements" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Placements</h2>
                    <div class="action-bar">
                        <div class="filters"></div>
                        <div class="actions">
                            <button onclick="manageColumns('placements')" class="btn-success btn-sm">‚öôÔ∏è</button>
                            <button onclick="openAddModal('placements')" class="btn-primary btn-sm">+ Add</button>
                            <button onclick="bulkEditPlacements()" class="btn-edit btn-sm">Edit</button>
                            <button onclick="bulkDeletePlacements()" class="btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="placements-table">
                        <thead id="placements-thead"></thead>
                        <tbody id="placements-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RISK TAB -->
        <div id="content-risk" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Risk & Compliance</h2>
                    <div class="action-bar">
                        <div class="filters"></div>
                        <div class="actions">
                            <button onclick="manageColumns('risk')" class="btn-success btn-sm">‚öôÔ∏è</button>
                            <button onclick="openAddModal('risk')" class="btn-primary btn-sm">+ Add</button>
                            <button onclick="bulkEditRisk()" class="btn-edit btn-sm">Edit</button>
                            <button onclick="bulkDeleteRisk()" class="btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="risk-table">
                        <thead id="risk-thead"></thead>
                        <tbody id="risk-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MARKET TAB -->
        <div id="content-market" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Market Intelligence</h2>
                    <div class="action-bar">
                        <div class="filters"></div>
                        <div class="actions">
                            <button onclick="manageColumns('market')" class="btn-success btn-sm">‚öôÔ∏è</button>
                            <button onclick="openAddModal('market')" class="btn-primary btn-sm">+ Add</button>
                            <button onclick="bulkEditMarket()" class="btn-edit btn-sm">Edit</button>
                            <button onclick="bulkDeleteMarket()" class="btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="market-table">
                        <thead id="market-thead"></thead>
                        <tbody id="market-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRAINING TAB -->
        <div id="content-training" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Training</h2>
                    <div class="action-bar">
                        <div class="filters"></div>
                        <div class="actions">
                            <button onclick="manageColumns('training')" class="btn-success btn-sm">‚öôÔ∏è</button>
                            <button onclick="openAddModal('training')" class="btn-primary btn-sm">+ Add</button>
                            <button onclick="bulkEditTraining()" class="btn-edit btn-sm">Edit</button>
                            <button onclick="bulkDeleteTraining()" class="btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="training-table">
                        <thead id="training-thead"></thead>
                        <tbody id="training-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Column Management Modal -->
    <div id="column-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Manage Columns</h2>
            <p class="text-sm text-gray-600 mb-4">Add or remove columns for <span id="column-collection-name"></span></p>
            
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Add New Column</h3>
                <div class="flex gap-2">
                    <input type="text" id="new-column-name" placeholder="Column Name" class="flex-1">
                    <button onclick="addColumn()" class="btn-primary">Add</button>
                </div>
            </div>
            
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Current Columns</h3>
                <div id="column-list" class="column-list"></div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeColumnModal()" class="btn-secondary flex-1">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Edit Item</h2>
            <form id="edit-form" onsubmit="saveItem(event)"></form>
            <div class="flex gap-3 mt-6">
                <button type="submit" form="edit-form" class="btn-primary flex-1">Save</button>
                <button onclick="closeModal()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Debug Panel Toggle -->
    <button id="debug-toggle" class="debug-toggle btn-secondary">Debug</button>
    <button id="export-csvs" class="debug-toggle btn-secondary" style="right:120px;">Export CSVs</button>
    <div id="debug-panel" class="debug-panel" style="display:none">
        <h4>Debug panel</h4>
        <div id="debug-content">Initializing...</div>
    </div>

    <!-- Snackbar for transient actions (undo) -->
    <div id="snackbar" class="snackbar" role="status" aria-live="polite">
        <span class="msg" id="snackbar-message">Action completed</span>
        <button id="snackbar-undo">Undo</button>
    </div>

    <!-- Row popover for pipeline details -->
    <div id="row-popover" class="row-popover" role="dialog" aria-hidden="true">
        <button class="close-btn" id="row-popover-close">‚úñ</button>
        <button class="pop-edit-btn" id="row-popover-edit" title="Edit">‚úé</button>
        <h4 id="row-popover-title">Details</h4>
        <div id="row-popover-content"></div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA1WKOUlVF1YvBMolSVACHOXz2kGQ_a6Sc",
          authDomain: "powerplus-dashboard.firebaseapp.com",
          projectId: "powerplus-dashboard",
          storageBucket: "powerplus-dashboard.firebasestorage.app",
          messagingSenderId: "506858654374",
          appId: "1:506858654374:web:06e47ff0cd5f8ae7808267",
          measurementId: "G-H1BJQBB3KP"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentCollection = '';
        let currentDocId = '';
        let allData = {};
        let sortStates = {};
        let filterStates = { pipeline: 'all', candidates: 'all' };
        let searchStates = { pipeline: '', candidates: '', employers: '' };
        let selectedItems = { pipeline: [], candidates: [], employers: [], placements: [], risk: [], market: [], training: [] };
        let chartsInitialized = false;
        let charts = {};
        let placementsChartType = 'bar'; // controls overview placements chart view
        // fixed 12-month window starting 01.01.2026 per request
        // bulk / modal helpers
        let multiEditSelection = [];
        let isBulkEdit = false;
        let isPromotion = false;
        let promotionSourceId = '';
        // promotion undo helpers
        let promotionSavedData = null;
        let promotionCreatedEmployerId = null;
        let promotionUndoTimeout = null;
        
        // Column configuration - stored in localStorage
      let columnConfig = {
    pipeline: ['Company', 'Branch', 'Region', 'Stage', 'Priority', 'Potential', 'Phone', 'Last Contacted'], // <-- nur Potential, kein Need mehr!
    candidates: ['Candidate', 'Qualification', 'Experience (Years)', 'Key Skills', 'German Level', 'Overall Score', 'Status', 'Visa Status', 'Earliest start'],
    employers: ['Company', 'Branch', 'Trust Score', 'Phone', 'Current PowerPlus Workers', 'Notes'],
    placements: ['Candidate', 'Company', 'Branch', 'Start Date', 'End Date', 'Status'],
    risk: ['Item', 'Type', 'Risk Level', 'Status'],
    market: ['Branch', 'Vacancy Rate', 'Regional Demand', 'Priority Score'],
    training: ['Module', 'Type', 'Duration', 'Status']
};

// Alte LocalStorage-Version sofort und brutal l√∂schen
localStorage.removeItem('columnConfig');
localStorage.removeItem('columnLabels');

// Debug: Sofort pr√ºfen, ob es wirklich "Candidate" ist
console.log("=== DEBUG: Aktuelle Spalten f√ºr candidates ===");
console.log(columnConfig.candidates);  // MUSS ["Candidate", ...] ausgeben!

// Sofort √ºberschreiben & debuggen
localStorage.removeItem('columnConfig');  // killt alte Version
console.log("=== FORCED pipeline columns ===", columnConfig.pipeline);

        // Load column config from localStorage
        const savedConfig = localStorage.getItem('columnConfig');
        if (savedConfig) {
            columnConfig = JSON.parse(savedConfig);
        }

        // Column labels mapping (keeps displayed label separate from data key)
        let columnLabels = {};
        const savedLabels = localStorage.getItem('columnLabels');
        if (savedLabels) {
            try { columnLabels = JSON.parse(savedLabels); } catch(e) { columnLabels = {}; }
        }
        // ensure defaults for any collection/column
        Object.keys(columnConfig).forEach(coll => {
            if (!columnLabels[coll]) columnLabels[coll] = {};
            columnConfig[coll].forEach(c => { if (!columnLabels[coll][c]) columnLabels[coll][c] = c; });
        });

        function saveColumnLabels() {
            try { localStorage.setItem('columnLabels', JSON.stringify(columnLabels)); } catch(e) { console.warn('Could not save column labels', e); }
        }

        // Export all collections as CSV files (downloads). Run client-side using current Firestore auth.
        async function exportAllCollectionsToCSV() {
            const collections = ['pipeline', 'candidates', 'employers', 'placements', 'risk', 'market', 'training'];
            const ts = new Date().toISOString().replace(/[:.]/g,'-');
            const valueToString = (v) => {
                if (v === null || typeof v === 'undefined') return '';
                try {
                    if (v && typeof v.toDate === 'function') return v.toDate().toISOString();
                    if (v && typeof v.seconds === 'number') return new Date(v.seconds * 1000).toISOString();
                } catch (e) {}
                if (typeof v === 'object') return JSON.stringify(v);
                return String(v);
            };

            for (const coll of collections) {
                try {
                    // WICHTIG: Nutze allData aus dem Browser, NICHT Firestore!
                    const rows = (allData[coll] || []).map(d => {
                        const row = { _id: d._id || d.id || '' };
                        // Kopiere alle Felder
                        for (const key in d) {
                            if (key !== '_id' && key !== 'id') {
                                row[key] = d[key];
                            }
                        }
                        return row;
                    });
                    
                    if (!rows.length) {
                        // create empty csv with only _id
                        const emptyCsv = '_id\n';
                        triggerDownload(`${coll}_export_${ts}.csv`, emptyCsv);
                        continue;
                    }
                    // build header union
                    const headerSet = new Set();
                    rows.forEach(r => Object.keys(r).forEach(k => headerSet.add(k)));
                    const headers = Array.from(headerSet);
                    // ensure _id first
                    if (!headers.includes('_id')) headers.unshift('_id'); else { headers.splice(headers.indexOf('_id'),1); headers.unshift('_id'); }

                    const csvLines = [];
                    csvLines.push(headers.join('\t'));
                    rows.forEach(r => {
                        const vals = headers.map(h => {
                            const val = typeof r[h] !== 'undefined' ? r[h] : '';
                            return valueToString(val);
                        });
                        csvLines.push(vals.join('\t'));
                    });

                    const csv = csvLines.join('\n');
                    triggerDownload(`${coll}_export_${ts}.csv`, csv);
                } catch (err) {
                    console.error('Export failed for', coll, err);
                    alert('Export failed for ' + coll + ': ' + (err.message || err));
                }
            }
            alert('Exports gestartet ‚Äî schau in deinen Downloads.');
        }

        function triggerDownload(filename, content) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 2000);
        }

        // Save column config to localStorage
        function saveColumnConfig() {
            localStorage.setItem('columnConfig', JSON.stringify(columnConfig));
        }

        // Load all collections
        function loadAllCollections() {
            ['pipeline', 'candidates', 'employers', 'placements', 'risk', 'market', 'training'].forEach(coll => {
                db.collection(coll).onSnapshot(snapshot => {
                    allData[coll] = [];
                    snapshot.forEach(doc => {
                        allData[coll].push({ id: doc.id, ...doc.data() });
                    });
                    renderTable(coll);
                    updateMetrics();
                    // always update charts when data changes so overview reflects latest data
                    updateCharts();
                    chartsInitialized = true;
                });
            });

            
            
            setInterval(() => {
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('de-DE');
            }, 1000);
        }

        // Chart.js small plugin to draw data labels for charts that opt-in
        const dataLabelPlugin = {
            id: 'dataLabelPlugin',
            afterDatasetsDraw: function(chart) {
                if (!chart.options.plugins || !chart.options.plugins.showDataLabels) return;
                const ctx = chart.ctx;
                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);
                    meta.data.forEach((element, index) => {
                        const data = dataset.data[index];
                        if (data === null || typeof data === 'undefined') return;
                        const pos = element.tooltipPosition();
                        ctx.fillStyle = '#0f172a';
                        ctx.font = '12px system-ui, -apple-system, Roboto, "Helvetica Neue", Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(String(data), pos.x, pos.y - 6);
                    });
                });
            }
        };
        Chart.register(dataLabelPlugin);

        // Update metrics
        function updateMetrics() {
            // Placements this month
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const placementsThisMonth = (allData.placements || []).filter(p => {
                if (!p['Start Date']) return false;
                const startDate = parseDateValue(p['Start Date']);
                if (!startDate) return false;
                return startDate.getMonth() === currentMonth && startDate.getFullYear() === currentYear;
            }).length;
            // previous month
            const prevDate = new Date(); prevDate.setMonth(prevDate.getMonth() - 1);
            const prevMonth = prevDate.getMonth();
            const prevYear = prevDate.getFullYear();
            const placementsPrevMonth = (allData.placements || []).filter(p => {
                if (!p['Start Date']) return false;
                const startDate = parseDateValue(p['Start Date']);
                if (!startDate) return false;
                return startDate.getMonth() === prevMonth && startDate.getFullYear() === prevYear;
            }).length;
            
            document.getElementById('metric-placements-month').textContent = placementsThisMonth;
            const percentage = Math.min((placementsThisMonth / 10) * 100, 100);
            document.getElementById('metric-placements-bar').style.width = percentage + '%';
            // change vs last month
            const changeEl = document.getElementById('metric-placements-change');
            if (placementsPrevMonth === 0) {
                changeEl.textContent = placementsThisMonth === 0 ? 'No change vs last month' : `+${placementsThisMonth * 100}% vs last month`;
            } else {
                const pct = Math.round(((placementsThisMonth - placementsPrevMonth) / placementsPrevMonth) * 100);
                changeEl.textContent = (pct >= 0 ? '+' : '') + pct + '% vs last month';
            }
            const targetPctEl = document.getElementById('metric-placements-target-percent');
            if (targetPctEl) targetPctEl.textContent = Math.round(percentage) + '%';
            
            // Other metrics
            const pipelineCount = (allData.pipeline || []).length;
            document.getElementById('metric-pipeline').textContent = pipelineCount;
            // pipeline breakdown
            const pipelineStages = {};
            (allData.pipeline || []).forEach(p => {
                const stage = normalizeStage(safeGet(p, 'Stage', 'stage') || 'Unknown');
                pipelineStages[stage] = (pipelineStages[stage] || 0) + 1;
            });
            const leads = pipelineStages['Prospect'] || 0;
            const meetings = pipelineStages['Meeting'] || 0;
            const proposals = pipelineStages['Proposal'] || 0;
            const pipelineDetailsEl = document.getElementById('metric-pipeline-details');
            if (pipelineDetailsEl) pipelineDetailsEl.innerHTML = `Leads: <b>${leads}</b> &nbsp; Meetings: <b>${meetings}</b> &nbsp; Proposals: <b>${proposals}</b>`;

            const AvailableCount = (allData.candidates || []).filter(c => String((c.Status||'')).trim() === 'Available').length;
            document.getElementById('metric-candidates').textContent = AvailableCount;
            // candidates breakdown
            const candStatuses = {};
            (allData.candidates || []).forEach(c => { const s = String(c.Status || 'Unknown').trim(); candStatuses[s] = (candStatuses[s]||0)+1; });
            const candDetailsEl = document.getElementById('metric-candidates-details');
            if (candDetailsEl) candDetailsEl.innerHTML = `Screening: <b>${candStatuses['Screening']||0}</b> &nbsp; Training: <b>${candStatuses['Training']||0}</b> &nbsp; Available: <b>${candStatuses['Available']||0}</b>`;

            const riskCount = (allData.risk || []).filter(r => String((r['Risk Level']||'')).trim() === 'High').length;
            document.getElementById('metric-risk').textContent = riskCount;
            // employers metrics
            const employers = allData.employers || [];
            const activePartners = employers.length;
            let trustSum = 0; let trustCount=0; let highEng=0;
            employers.forEach(e => { const t = parseFloat(e['Trust Score']); if (!isNaN(t)) { trustSum+=t; trustCount++; if (t>=4.0) highEng++; } });
            const avgTrust = trustCount ? (trustSum/trustCount) : 0;
            const avgTrustEl = document.getElementById('metric-employers-avg-trust');
            const empActEl = document.getElementById('metric-employers-active');
            if (avgTrustEl) avgTrustEl.textContent = `Avg Trust Score: ${avgTrust ? avgTrust.toFixed(1) : '‚Äî'}`;
            if (empActEl) empActEl.textContent = `Active Partners: ${activePartners} | High Engagement: ${highEng}`;
        }

        // Update charts
        function updateCharts() {
            console.debug('updateCharts: counts', {
                placements: (allData.placements||[]).length,
                pipeline: (allData.pipeline||[]).length,
                candidates: (allData.candidates||[]).length
            });
            // Placements: fixed 12 months starting 01.01.2026
            const months = [];
            const placementCounts = [];
            const start = new Date(2026, 0, 1); // Jan 1, 2026
            for (let i = 0; i < 12; i++) {
                const date = new Date(start.getFullYear(), start.getMonth() + i, 1);
                const monthName = date.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
                months.push(monthName);
                const count = (allData.placements || []).filter(p => {
                    if (!p['Start Date']) return false;
                    const startDate = parseDateValue(p['Start Date']);
                    if (!startDate) return false;
                    return startDate.getMonth() === date.getMonth() && startDate.getFullYear() === date.getFullYear();
                }).length;
                placementCounts.push(count);
            }

            // If a single month is selected via chips, reduce months/counts to that single month
            if (placementsFilterMonth) {
                const idx = months.indexOf(placementsFilterMonth);
                if (idx > -1) {
                    const m = months[idx];
                    const c = placementCounts[idx];
                    months.length = 0; placementCounts.length = 0; months.push(m); placementCounts.push(c);
                }
            }

            if (charts.placementsMonth) charts.placementsMonth.destroy();
            const ctxPlacementsMonth = document.getElementById('placementsMonthChart').getContext('2d');
            const type = placementsChartType || 'bar';
            const currentKey = new Date().toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
            const dataset = type === 'bar' ? {
                label: 'Placements',
                data: placementCounts,
                backgroundColor: placementCounts.map((c,i) => (months[i] === currentKey ? '#10B981' : (c > 0 ? '#6366f1' : '#e5e7eb'))),
                borderColor: '#6366f1',
                borderWidth: 2
            } : {
                label: 'Placements',
                data: placementCounts,
                backgroundColor: placementCounts.map((c,i) => (months[i] === currentKey ? 'rgba(16,185,129,0.2)' : 'rgba(99,102,241,0.15)')),
                borderColor: '#6366f1',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            };

            charts.placementsMonth = new Chart(ctxPlacementsMonth, {
                type,
                data: { labels: months, datasets: [dataset] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false }, showDataLabels: true },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1, callback: function(v){ return Number.isInteger(v) ? v : ''; } } } }
                }
            });

            // store last months for chips and render chips
            window.lastPlacementMonths = months.slice();
            window.lastPlacementCounts = placementCounts.slice();
            try { renderPlacementChips(); } catch(e){/* ignore */}

            // Pipeline by stage (normalize and use consistent stage color map)
            const stageOrder = ['Prospect','Contacted','Qualified','Meeting','Proposal','Negotiation','Deal Won'];
            const stageColors = {
                'Prospect': '#9CA3AF',
                'Contacted': '#60A5FA',
                'Qualified': '#2563EB',
                'Meeting': '#7C3AED',
                'Proposal': '#F59E0B',
                'Negotiation': '#EF4444',
                'Deal Won': '#10B981'
            };
            const stages = {};
            (allData.pipeline || []).forEach(p => {
                const raw = safeGet(p, 'Stage', 'stage') || 'Unknown';
                const stage = normalizeStage(raw);
                stages[stage] = (stages[stage] || 0) + 1;
            });

            if (charts.pipeline) charts.pipeline.destroy();
            const ctxPipeline = document.getElementById('pipelineChart').getContext('2d');
            const pipelineLabels = stageOrder.slice();
            const pipelineData = pipelineLabels.map(l => stages[l] || 0);
            const pipelineColors = pipelineLabels.map(l => stageColors[l] || '#9CA3AF');
            charts.pipeline = new Chart(ctxPipeline, {
                type: 'bar',
                data: { labels: pipelineLabels, datasets: [{ data: pipelineData, backgroundColor: pipelineColors }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1, callback: function(v){ return Number.isInteger(v) ? v : ''; } } } } }
            });

            // Candidates by status (normalize)
            const statuses = {};
            (allData.candidates || []).forEach(c => {
                let status = c.Status || 'Unknown';
                status = String(status || 'Unknown').trim();
                statuses[status] = (statuses[status] || 0) + 1;
            });

            if (charts.candidates) charts.candidates.destroy();
            const ctxCandidates = document.getElementById('candidatesChart').getContext('2d');
            const statusLabels = Object.keys(statuses);
            const statusData = statusLabels.map(l => statuses[l]);
            const statusColors = ['#10b981', '#f59e0b', '#3b82f6', '#9CA3AF', '#8B5CF6'].slice(0, statusLabels.length);
            charts.candidates = new Chart(ctxCandidates, {
                type: 'doughnut',
                data: { labels: statusLabels, datasets: [{ data: statusData, backgroundColor: statusColors }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Branch distribution (normalize)
            const branches = {};
            (allData.pipeline || []).forEach(p => {
                let branch = p.Branch || 'Unknown';
                branch = String(branch || 'Unknown').trim();
                branches[branch] = (branches[branch] || 0) + 1;
            });

            if (charts.branch) charts.branch.destroy();
            const ctxBranch = document.getElementById('branchChart').getContext('2d');
            const branchLabels = Object.keys(branches);
            const branchData = branchLabels.map(l => branches[l]);
            const branchPalette = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#60A5FA', '#10B981'];
            const branchColors = branchLabels.map((_, i) => branchPalette[i % branchPalette.length]);
            charts.branch = new Chart(ctxBranch, {
                type: 'pie',
                data: { labels: branchLabels, datasets: [{ data: branchData, backgroundColor: branchColors }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // update debug panel content to help diagnose missing counts
            try { updateDebugPanel(); } catch (e) { console.debug('debug panel update failed', e); }
        }

        function setSearch(collection, value) {
            searchStates[collection] = (value || '').trim().toLowerCase();
            renderTable(collection);
        }

        let popoverPinnedId = null;
        let popoverHideTimeout = null;

        function showRowPopover(item, rowElem, pinned) {
            const pop = document.getElementById('row-popover');
            const content = document.getElementById('row-popover-content');
            const title = document.getElementById('row-popover-title');
            if (!pop || !content || !title) return;
            title.textContent = item.Company || item.Company || 'Details';
            const branch = escapeHtml(item.Branch || '‚Äî');
            const region = escapeHtml(item.Region || '‚Äî');
            const contact = escapeHtml(item['Contact Person'] || item.Contact || '‚Äî');
            const phoneRaw = item.Phone || item['Phone'] || '';
            const phone = phoneRaw ? `<a href="tel:${escapeHtml(phoneRaw)}">${escapeHtml(phoneRaw)}</a>` : '‚Äî';
            const emailRaw = item.Email || item.Email || '';
            const email = emailRaw ? `<a href="mailto:${escapeHtml(emailRaw)}">${escapeHtml(emailRaw)}</a>` : '‚Äî';
            const websiteRaw = item.Website || item['Website'] || '';
            const website = websiteRaw ? `<a href="${escapeHtml(websiteRaw)}" target="_blank" rel="noopener">${escapeHtml(websiteRaw)}</a>` : '‚Äî';
            content.innerHTML = `<div class="metric-small">Branch: ${branch}</div><div class="metric-small">Region: ${region}</div><div style="margin-top:6px">Contact: ${contact}</div><div>Phone: ${phone}</div><div>Email: ${email}</div><div style="margin-top:6px">Website: ${website}</div>`;
            pop.style.display = 'block';
            pop.setAttribute('aria-hidden','false');
            // store current id and row id to allow edit/save to re-open
            pop.dataset.currentId = item.id || '';
            pop.dataset.rowId = item.id || '';
            // If user has dragged/placed the popover before, reopen at saved position
            let usedSaved = false;
            try {
                const saved = JSON.parse(localStorage.getItem('rowPopoverPos') || 'null');
                if (saved && saved.left && saved.top) {
                    pop.style.left = saved.left;
                    pop.style.top = saved.top;
                    usedSaved = true;
                }
            } catch (e) { usedSaved = false; }

            if (!usedSaved) {
                // Default: midway-left of the viewport (not over company column) and vertically centered on row
                const margin = 12;
                const rect = rowElem.getBoundingClientRect();
                const popRect = pop.getBoundingClientRect();
                let left = Math.round(window.innerWidth * 0.35 - popRect.width / 2);
                if (left < margin) left = margin;
                if (left + popRect.width > window.innerWidth - margin) left = Math.max(margin, window.innerWidth - popRect.width - margin);
                let top = rect.top + window.scrollY + (rect.height / 2) - (popRect.height / 2);
                const viewportTop = window.scrollY + margin;
                const viewportBottom = window.scrollY + window.innerHeight - margin;
                if (top < viewportTop) top = viewportTop;
                if (top + popRect.height > viewportBottom) top = Math.max(viewportTop, viewportBottom - popRect.height);
                pop.style.left = Math.round(left) + 'px';
                pop.style.top = Math.round(top) + 'px';
            }
            if (!pinned) {
                // clear any pending hide and add popover hover listeners to avoid flicker when moving mouse
                if (popoverHideTimeout) { clearTimeout(popoverHideTimeout); popoverHideTimeout = null; }
                pop.onmouseenter = () => { if (popoverHideTimeout) { clearTimeout(popoverHideTimeout); popoverHideTimeout = null; } };
                pop.onmouseleave = () => { if (popoverHideTimeout) clearTimeout(popoverHideTimeout); popoverHideTimeout = setTimeout(() => { if (!popoverPinnedId) hideRowPopover(); }, 300); };
                // auto-hide after 2s when not pinned, but allow hover to cancel
                popoverHideTimeout = setTimeout(() => { if (!popoverPinnedId) hideRowPopover(); }, 2000);
            } else {
                popoverPinnedId = item.id;
            }
        }

        function hideRowPopover() {
            const pop = document.getElementById('row-popover');
            if (!pop) return;
            pop.style.display = 'none';
            pop.setAttribute('aria-hidden','true');
            popoverPinnedId = null;
            if (popoverHideTimeout) { clearTimeout(popoverHideTimeout); popoverHideTimeout = null; }
        }

        document.getElementById('row-popover-close').addEventListener('click', () => { popoverPinnedId = null; hideRowPopover(); });

        // Edit button inside popover: allow small inline edit of key fields
        const popEditBtn = document.getElementById('row-popover-edit');
        if (popEditBtn) {
            popEditBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const pop = document.getElementById('row-popover');
                const id = pop.dataset.currentId;
                if (!id) return;
                const item = (allData.pipeline || []).find(i => i.id === id) || {};
                const content = document.getElementById('row-popover-content');
                content.innerHTML = `
                    <label class="metric-small">Company</label>
                    <input id="pop-edit-company" type="text" value="${escapeHtml(item.Company||'')}" style="margin-bottom:6px;">
                    <label class="metric-small">Branch</label>
                    <input id="pop-edit-branch" type="text" value="${escapeHtml(item.Branch||'')}" style="margin-bottom:6px;">
                    <label class="metric-small">Contact</label>
                    <input id="pop-edit-contact" type="text" value="${escapeHtml(item['Contact Person']||item.Contact||'')}" style="margin-bottom:6px;">
                    <label class="metric-small">Phone</label>
                    <input id="pop-edit-phone" type="text" value="${escapeHtml(item.Phone||item['Phone']||'')}" style="margin-bottom:6px;">
                    <label class="metric-small">Email</label>
                    <input id="pop-edit-email" type="text" value="${escapeHtml(item.Email||'')}" style="margin-bottom:6px;">
                    <label class="metric-small">Website</label>
                    <input id="pop-edit-website" type="text" value="${escapeHtml(item.Website||item['Website']||'')}" style="margin-bottom:6px;">
                    <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
                        <button id="pop-edit-save" class="btn-primary btn-sm">Save</button>
                        <button id="pop-edit-cancel" class="btn-secondary btn-sm">Cancel</button>
                    </div>
                `;

                // cancel handler
                document.getElementById('pop-edit-cancel').addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) showRowPopover(item, row, true);
                    else hideRowPopover();
                });

                // save handler
                document.getElementById('pop-edit-save').addEventListener('click', async (ev) => {
                    ev.stopPropagation();
                        const updated = {
                        Company: document.getElementById('pop-edit-company').value.trim(),
                        Branch: document.getElementById('pop-edit-branch').value.trim(),
                        'Contact Person': document.getElementById('pop-edit-contact').value.trim(),
                        Phone: document.getElementById('pop-edit-phone').value.trim(),
                        Email: document.getElementById('pop-edit-email').value.trim(),
                        Website: document.getElementById('pop-edit-website').value.trim()
                    };
                    try {
                        await db.collection('pipeline').doc(id).update(updated);
                        // re-render and re-open popover
                        renderTable('pipeline');
                        setTimeout(() => {
                            const newRow = document.querySelector(`tr[data-id="${id}"]`);
                            if (newRow) showRowPopover(Object.assign({}, item, updated), newRow, true);
                        }, 80);
                    } catch (err) {
                        alert('Save failed: ' + (err.message || err));
                    }
                });
            });
        }

        // Snackbar helper to show message + undo callback
        function showSnackbar(message, timeout = 6000, onUndo = null) {
            const el = document.getElementById('snackbar');
            const msg = document.getElementById('snackbar-message');
            const undoBtn = document.getElementById('snackbar-undo');
            if (!el || !msg || !undoBtn) return;
            msg.textContent = message;
            el.style.display = 'flex';
            // remove previous listener
            const newUndo = undoBtn.cloneNode(true);
            undoBtn.parentNode.replaceChild(newUndo, undoBtn);
            newUndo.addEventListener('click', async () => {
                try {
                    if (typeof onUndo === 'function') await onUndo();
                } catch (e) { console.error('undo handler failed', e); }
                el.style.display = 'none';
                if (promotionUndoTimeout) { clearTimeout(promotionUndoTimeout); promotionUndoTimeout = null; }
            });

            // auto-hide
            if (promotionUndoTimeout) clearTimeout(promotionUndoTimeout);
            promotionUndoTimeout = setTimeout(() => {
                el.style.display = 'none';
                promotionUndoTimeout = null;
            }, timeout);
        }

        function togglePlacementsChart(type) {
            placementsChartType = type;
            const barBtn = document.getElementById('placements-bar-btn');
            const lineBtn = document.getElementById('placements-line-btn');
            if (barBtn && lineBtn) {
                barBtn.classList.remove('bg-indigo-600','text-white');
                lineBtn.classList.remove('bg-indigo-600','text-white');
                if (type === 'bar') barBtn.classList.add('bg-indigo-600','text-white');
                else lineBtn.classList.add('bg-indigo-600','text-white');
            }
            updateCharts();
        }

        // no range toggle; show fixed 12 months from 01.01.2026

        let placementsFilterMonth = null;

        function renderPlacementChips() {
            const container = document.getElementById('placements-month-chips');
            if (!container) return;
            container.innerHTML = '';
            const months = window.lastPlacementMonths || [];
            months.forEach(m => {
                const btn = document.createElement('button');
                btn.className = 'month-chip' + (placementsFilterMonth === m ? ' active' : '');
                btn.textContent = m;
                btn.onclick = () => {
                    if (placementsFilterMonth === m) placementsFilterMonth = null;
                    else placementsFilterMonth = m;
                    renderPlacementChips();
                    updateCharts();
                };
                container.appendChild(btn);
            });
        }
        
        function safeGet(obj, ...keys) {
            for (const k of keys) {
                if (obj && typeof obj[k] !== 'undefined') return obj[k];
            }
            return undefined;
        }

        function parseDateValue(val) {
            if (!val && val !== 0) return null;
            try {
                // Firestore Timestamp
                if (val && typeof val.toDate === 'function') return val.toDate();
                // object with seconds
                if (val && typeof val === 'object' && typeof val.seconds === 'number') return new Date(val.seconds * 1000);
                // numeric (epoch ms)
                if (typeof val === 'number') return new Date(val);
                // string ISO (YYYY-MM-DD) or ISO-like
                if (typeof val === 'string') {
                    const s = val.trim();
                    // dd.mm.yyyy or d.m.yyyy
                    const dotMatch = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})$/);
                    if (dotMatch) {
                        const day = parseInt(dotMatch[1], 10);
                        const month = parseInt(dotMatch[2], 10) - 1;
                        let year = parseInt(dotMatch[3], 10);
                        if (year < 100) year += 2000;
                        return new Date(year, month, day);
                    }
                    // ISO or yyyy-mm-dd
                    const iso = new Date(s);
                    if (!isNaN(iso.getTime())) return iso;
                    // fallback: try replacing dots with dashes
                    const alt = new Date(s.replace(/\./g,'-'));
                    if (!isNaN(alt.getTime())) return alt;
                }
            } catch (e) {
                return null;
            }
            return null;
        }

        function normalizeStage(raw) {
            if (!raw && raw !== 0) return 'Unknown';
            let s = String(raw).trim();
            if (!s) return 'Unknown';
            const low = s.toLowerCase();
            // map common variants into canonical stages
            if (low.includes('lead')) return 'Prospect';
            if (low.includes('discovery') || low.includes('needs analysis') || low.includes('needs')) return 'Prospect';
            if (low.includes('prospect')) return 'Prospect';
            if (low.includes('contact')) return 'Contacted';
            if (low.includes('qualif')) return 'Qualified';
            if (low.includes('meeting')) return 'Meeting';
            if (low.includes('proposal')) return 'Proposal';
            if (low.includes('negoti') || low.includes('negotia')) return 'Negotiation';
            if (low.includes('deal') || low.includes('won')) return 'Deal Won';
            return s; // return original if no mapping
        }

        function updateDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const content = document.getElementById('debug-content');
            if (!content) return;

            const placements = allData.placements || [];
            const pipeline = allData.pipeline || [];
            const candidates = allData.candidates || [];

            // pipeline stage summary
            const stageMap = {};
            pipeline.forEach(p => {
                const raw = safeGet(p, 'Stage', 'stage') || 'Unknown';
                const stage = normalizeStage(raw);
                stageMap[stage] = (stageMap[stage] || 0) + 1;
            });

            // placements month sample and keys
            const placementMonths = {};
            const placementSamples = placements.slice(0,5).map(p => ({ id: p.id, raw: p['Start Date'], keys: Object.keys(p) }));
            placements.forEach(p => {
                let startDate;
                try {
                    if (p['Start Date'] && typeof p['Start Date'].toDate === 'function') startDate = p['Start Date'].toDate();
                    else if (p['Start Date'] && p['Start Date'].seconds) startDate = new Date(p['Start Date'].seconds * 1000);
                    else if (typeof p['Start Date'] === 'number') startDate = new Date(p['Start Date']);
                    else startDate = new Date(p['Start Date']);
                } catch (e) { startDate = null; }
                if (startDate && !isNaN(startDate.getTime())) {
                    const key = startDate.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
                    placementMonths[key] = (placementMonths[key] || 0) + 1;
                }
            });

            const html = [];
            html.push('<div><b>Counts</b> ‚Äî placements: ' + placements.length + ', pipeline: ' + pipeline.length + ', candidates: ' + candidates.length + '</div>');
            html.push('<div style="margin-top:8px"><b>Pipeline stages</b><br/>' + Object.entries(stageMap).map(([k,v]) => `${k}: ${v}`).join('<br/>') + '</div>');
            html.push('<div style="margin-top:8px"><b>Placement months</b><br/>' + (Object.keys(placementMonths).length ? Object.entries(placementMonths).map(([k,v]) => `${k}: ${v}`).join('<br/>') : 'none parsed') + '</div>');
            html.push('<div style="margin-top:8px"><b>Pipeline sample (first 5)</b><pre>' + pipeline.slice(0,5).map(p=> `${p.id} | Stage=${safeGet(p,'Stage','stage') || ''} | Keys=${Object.keys(p).join(',')}`).join('\n') + '</pre></div>');
            html.push('<div style="margin-top:8px"><b>Placements sample (first 5)</b><pre>' + placementSamples.map(s=> `${s.id} | raw=${JSON.stringify(s.raw)} | keys=${s.keys.join(',')}`).join('\n') + '</pre></div>');

            content.innerHTML = html.join('');
            // show panel briefly if hidden
            if (panel && panel.style.display === 'none') panel.style.display = 'block';
        }

        document.getElementById('debug-toggle').addEventListener('click', () => {
            const p = document.getElementById('debug-panel');
            if (!p) return;
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
        });
        document.getElementById('export-csvs').addEventListener('click', () => {
            if (!confirm('Exportiere alle Collections als CSV und starte Downloads?')) return;
            exportAllCollectionsToCSV();
        });
        // Render table with dynamic columns
        function renderTable(collection) {
            const thead = document.getElementById(collection + '-thead');
            const tbody = document.getElementById(collection + '-tbody');
            if (!thead || !tbody) return;
            
            const columns = columnConfig[collection] || [];
            let data = allData[collection] || [];
            
            // Apply filter
            if (filterStates[collection] && filterStates[collection] !== 'all') {
                if (collection === 'pipeline') {
                    data = data.filter(item => item.Branch === filterStates[collection]);
                } else if (collection === 'candidates') {
                    data = data.filter(item => item.Status === filterStates[collection]);
                }
            }

            // Apply search (case-insensitive) across item values
            const q = (searchStates[collection] || '').trim().toLowerCase();
            if (q) {
                data = data.filter(item => {
                    return Object.values(item).some(v => {
                        try { return String(v || '').toLowerCase().includes(q); } catch(e) { return false; }
                    });
                });
            }
            
            // Apply sorting
            if (sortStates[collection]) {
                const { field, direction } = sortStates[collection];
                data = [...data].sort((a, b) => {
                    let aVal = a[field] || '';
                    let bVal = b[field] || '';
                    
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return direction === 'asc' ? aNum - bNum : bNum - aNum;
                    }
                    
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    return direction === 'asc' ? 
                        (aVal < bVal ? -1 : aVal > bVal ? 1 : 0) :
                        (aVal > bVal ? -1 : aVal < bVal ? 1 : 0);
                });
            }
            
            // Render header (use displayedColumns to hide Branch/Region for pipeline)
            let displayedColumns = columns.slice();
            let addInfoColumn = false;
            if (collection === 'pipeline') { displayedColumns = columns.filter(c => c !== 'Branch' && c !== 'Region'); addInfoColumn = true; }
                thead.innerHTML = `<tr class="bg-gray-50 text-left">
                    <th class="px-4 py-3"><input type="checkbox" id="select-all-${collection}" onchange="selectAll${collection.charAt(0).toUpperCase() + collection.slice(1)}(this.checked)"></th>
                    ${displayedColumns.map(col => `<th data-col="${col}" class="px-4 py-3 text-sm font-semibold text-gray-700 sortable" onclick="sortTable('${collection}', '${col}')" draggable="true"><span class="header-label">${(columnLabels[collection] && columnLabels[collection][col])? columnLabels[collection][col] : col}</span> <button class="header-edit" data-col="${col}" title="Rename">‚úé</button> <span class="sort-arrow">‚ñº</span></th>`).join('')}
                    ${addInfoColumn ? '<th class="px-2 py-3"></th>' : ''}
                </tr>`;

                // enable header drag-and-drop to reorder columns
                Array.from(thead.querySelectorAll('th[draggable="true"][data-col]')).forEach(th => {
                    th.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', th.dataset.col); th.classList.add('opacity-50'); });
                    th.addEventListener('dragend', e => th.classList.remove('opacity-50'));
                    th.addEventListener('dragover', e => { e.preventDefault(); th.classList.add('ring-2', 'ring-indigo-300'); });
                    th.addEventListener('dragleave', e => th.classList.remove('ring-2', 'ring-indigo-300'));
                    th.addEventListener('drop', e => {
                        e.preventDefault(); th.classList.remove('ring-2', 'ring-indigo-300');
                        const draggedCol = e.dataTransfer.getData('text/plain');
                        const targetCol = th.dataset.col;
                        if (draggedCol && targetCol && draggedCol !== targetCol) {
                            const arr = columnConfig[collection];
                            const from = arr.indexOf(draggedCol);
                            const to = arr.indexOf(targetCol);
                            if (from > -1 && to > -1) {
                                arr.splice(to, 0, arr.splice(from, 1)[0]);
                                saveColumnConfig();
                                renderTable(collection);
                            }
                        }
                    });
                });

                // attach header rename handlers (label-only) for all collections
                Array.from(thead.querySelectorAll('.header-edit')).forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const key = btn.dataset.col;
                        const oldLabel = (columnLabels[collection] && columnLabels[collection][key]) ? columnLabels[collection][key] : key;
                        const newLabel = prompt('Neuer Spaltenname (nur Label)', oldLabel);
                        if (!newLabel || newLabel.trim() === '' || newLabel === oldLabel) return;
                        if (!columnLabels[collection]) columnLabels[collection] = {};
                        columnLabels[collection][key] = newLabel.trim();
                        saveColumnLabels();
                        renderTable(collection);
                    });
                });
            
            // Render body
            tbody.innerHTML = data.map(item => {
                const isSelected = selectedItems[collection].includes(item.id);
                let rowHTML = `<tr data-id="${item.id}" class="border-t hover:bg-gray-50" onclick="toggleRowSelection(event, '${collection}', '${item.id}')">
                    <td class="px-4 py-3"><input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleItemSelection('${collection}', '${item.id}')"></td>`;
                
                displayedColumns.forEach(col => {
                    let value = item[col] || '-';

                    

                    // Special rendering for certain columns
                    if (col === 'Status' && collection === 'candidates') {
                    const opts = ['Screening', 'Training', 'Available', 'Placement'];
                    const current = value && opts.includes(value) ? value : opts[0]; // fallback auf Screening, falls ung√ºltig
                    value = `<select class="status-select" data-id="${item.id}">` +
                    opts.map(o => `<option value="${o}" ${o === current ? 'selected' : ''}>${o}</option>`).join('') +
                    `</select>`;
                    } else if (col === 'Training Progress') {
                        const progress = parseInt((value || '0').replace('%', '')) || 0;
                        value = `<div><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div><span class="text-xs text-gray-600">${progress}%</span></div>`;
                    } else if (col === 'Trust Score' && collection === 'employers') {
                        const score = parseFloat(value) || 0;
                        const scoreClass = score >= 4.5 ? 'trust-5' : score >= 3.5 ? 'trust-4' : score >= 2.5 ? 'trust-3' : score >= 1.5 ? 'trust-2' : 'trust-1';
                        value = `<span class="trust-score ${scoreClass}">${score.toFixed(1)}</span>`;
                    } else if (col === 'Overall Score') {
                        value = `<span class="badge badge-green">${value}</span>`;
                    } else if (col === 'Stage' && collection === 'pipeline') {
                        // Inline stage selector with fixed options (normalize value so an option is selected)
                        const stage = normalizeStage(value || 'Prospect');
                        const opts = ['Prospect','Contacted','Qualified','Meeting','Proposal','Negotiation','Deal Won'];
                        value = `<select class="stage-select" data-id="${item.id}">` + opts.map(o => `<option value="${o}" ${o===stage? 'selected' : ''}>${o}</option>`).join('') + `</select>`;
                    } else if (col === 'Stage' || col === 'Priority' || col === 'Risk Level') {
                        const badgeClass = col === 'Risk Level' ? (value === 'High' ? 'red' : value === 'Medium' ? 'yellow' : 'green') : 'blue';
                        value = `<span class="badge badge-${badgeClass}">${value}</span>`;
                    } else if (col === 'Notes') {
                        value = `<span style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; display: block;" title="${value}">${value}</span>`;
                    }

                    rowHTML += `<td class="px-4 py-3 text-sm">${value}</td>`;
                });
                if (addInfoColumn) rowHTML += `<td class="px-2 py-3 text-sm"><button class="row-info-btn" data-id="${item.id}" title="Details">‚ÑπÔ∏è</button></td>`;
                rowHTML += '</tr>';
                return rowHTML;
            }).join('') || `<tr><td colspan="${displayedColumns.length + 1 + (addInfoColumn?1:0)}" class="px-4 py-8 text-center text-gray-500">No data</td></tr>`;

            // After rendering, attach stage-select handlers and color them
            try {
                if (collection === 'pipeline') {
                    const stageColors = {
                        'Prospect': '#9CA3AF',
                        'Contacted': '#60A5FA',
                        'Qualified': '#2563EB',
                        'Meeting': '#7C3AED',
                        'Proposal': '#F59E0B',
                        'Negotiation': '#EF4444',
                        'Deal Won': '#10B981'
                    };
                    const selects = tbody.querySelectorAll('select.stage-select');
                    selects.forEach(s => {
                        const setColor = (val) => { s.style.background = stageColors[val] || ''; s.style.color = '#fff'; s.style.borderRadius = '6px'; s.style.padding = '6px'; };
                        setColor(s.value);
                        // Prevent the row click from stealing focus / re-rendering the select
                        s.addEventListener('mousedown', e => { e.stopPropagation(); });
                        s.addEventListener('click', e => { e.stopPropagation(); });
                        s.addEventListener('change', async (e) => {
                            e.stopPropagation();
                            const newVal = e.target.value;
                            setColor(newVal);
                            const id = s.dataset.id;
                            try {
                                await db.collection('pipeline').doc(id).update({ Stage: newVal });
                                if (newVal === 'Deal Won') {
                                    const doc = await db.collection('pipeline').doc(id).get();
                                    if (doc.exists) openPromoteModal(id, doc.data());
                                }
                            } catch (err) {
                                alert('Error updating stage: ' + err.message);
                            }
                        });
                    });
                }
            } catch (err) { console.error(err); }

             // STATUS DROPDOWN HANDLER (Candidates)
            if (collection === 'candidates') {
                setTimeout(() => {
                    const statusColors = {
                        'Start': '#9CA3AF',
                        'Training': '#F59E0B',
                        'Available': '#10B981',
                        'Placement': '#6366F1'
                    };
                    const selects = tbody.querySelectorAll('select.status-select');
                    selects.forEach(s => {
                        const setColor = (val) => { s.style.background = statusColors[val] || '#9CA3AF'; s.style.color = '#fff'; s.style.borderRadius = '6px'; s.style.padding = '6px'; };
                        setColor(s.value);
                        s.addEventListener('mousedown', e => { e.stopPropagation(); });
                        s.addEventListener('click', e => { e.stopPropagation(); });
                        s.addEventListener('change', async (e) => {
                            e.stopPropagation();
                            const newVal = e.target.value;
                            setColor(newVal);
                            const id = s.dataset.id;
                            try {
                                await db.collection('candidates').doc(id).update({ Status: newVal });
                                if (newVal === 'Placement') {
                                    const doc = await db.collection('candidates').doc(id).get();
                                    if (doc.exists) openPlacementPromotionModal(id, doc.data());
                                }
                            } catch (err) {
                                alert('Error: ' + err.message);
                            }
                        });
                    });
                }, 50);
            }
        

            // Attach inline editors for editable cells (except dropdown fields)
            try { attachInlineEditors(collection); } catch (e) { console.debug('attachInlineEditors failed', e); }
            // Attach row info handlers (popover) after editors attached
            try {
                if (collection === 'pipeline') {
                    const rows = tbody.querySelectorAll('tr[data-id]');
                    rows.forEach(row => {
                        const id = row.dataset.id;
                        const item = (allData.pipeline || []).find(i => i.id === id);
                        if (!item) return;
                        const infoBtn = row.querySelector('.row-info-btn');
                        const companyCell = row.querySelector('td:nth-child(2)');
                        if (companyCell) {
                            companyCell.addEventListener('mouseenter', () => {
                                if (popoverHideTimeout) { clearTimeout(popoverHideTimeout); popoverHideTimeout = null; }
                                if (!popoverPinnedId) showRowPopover(item, row, false);
                            });
                            companyCell.addEventListener('mouseleave', () => {
                                if (popoverHideTimeout) { clearTimeout(popoverHideTimeout); popoverHideTimeout = null; }
                                popoverHideTimeout = setTimeout(() => { if (!popoverPinnedId) hideRowPopover(); }, 300);
                            });
                        }
                        if (infoBtn) {
                            infoBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (popoverPinnedId === id) { popoverPinnedId = null; hideRowPopover(); }
                                else { popoverPinnedId = id; showRowPopover(item, row, true); }
                            });
                        }
                    });
                }
            } catch (err) { console.debug('attachRowInfoHandlers failed', err); }
        }
        

        function escapeHtml(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        async function attachInlineEditors(collection) {
            const thead = document.getElementById(collection + '-thead');
            const tbody = document.getElementById(collection + '-tbody');
            if (!thead || !tbody) return;
            const headers = Array.from(thead.querySelectorAll('th[data-col]')).map(h => h.dataset.col);
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(row => {
                const id = row.dataset?.id || '';
                Array.from(row.querySelectorAll('td')).forEach((td, idx) => {
                    if (idx === 0) return; // checkbox column
                    const col = headers[idx-1];
                    if (!col) return;
                    // skip dropdown-controlled fields
                    if (collection === 'pipeline' && col === 'Stage') return;
                    if (collection === 'candidates' && (col === 'Status' || col === 'German Level')) return;
                    // skip complex rendered badges/progress by checking for inner elements
                    if (td.querySelector('select') || td.querySelector('.progress-bar') || td.querySelector('.trust-score') || td.querySelector('.badge')) return;
                    // already has inline editor
                    if (td.querySelector('.inline-edit')) return;

                    const rawText = td.textContent.trim();
                    td.innerHTML = `<div class="inline-edit"><span class="value">${escapeHtml(rawText)}</span><button class="edit-btn" title="Edit"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></svg></button></div>`;
                    const editBtn = td.querySelector('.edit-btn');
                    const valueSpan = td.querySelector('.value');
                    if (!editBtn || !valueSpan) return;
                    editBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        const old = valueSpan.textContent;
                        td.innerHTML = `<input class="inline-input" type="text" value="${escapeHtml(old)}"><button class="save-btn">üíæ</button><button class="cancel-btn">‚úñ</button>`;
                        const input = td.querySelector('.inline-input');
                        const saveBtn = td.querySelector('.save-btn');
                        const cancelBtn = td.querySelector('.cancel-btn');
                        // prevent row clicks from stealing focus
                        input.addEventListener('mousedown', e => e.stopPropagation());
                        input.addEventListener('click', e => e.stopPropagation());
                        saveBtn.addEventListener('mousedown', e => e.stopPropagation());
                        cancelBtn.addEventListener('mousedown', e => e.stopPropagation());
                        input.focus(); input.select();
                        const finish = async (save) => {
                            const newVal = input.value.trim();
                            if (save && newVal !== old) {
                                try {
                                    const update = {};
                                    update[col] = newVal;
                                    await db.collection(collection).doc(id).update(update);
                                    valueSpan.textContent = newVal;
                                } catch (err) {
                                    alert('Save failed: ' + err.message);
                                }
                            }
                            td.innerHTML = `<div class="inline-edit"><span class="value">${escapeHtml(save ? newVal : old)}</span><button class="edit-btn" title="Edit"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></svg></button></div>`;
                            // reattach editors for the entire table row (simpler)
                            setTimeout(() => attachInlineEditors(collection), 20);
                        };
                        saveBtn.addEventListener('click', (e) => { e.stopPropagation(); finish(true); });
                        cancelBtn.addEventListener('click', (e) => { e.stopPropagation(); finish(false); });
                        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); finish(true); } if (e.key === 'Escape') { e.preventDefault(); finish(false); } });
                    });
                });
            });
        }

        // Column management
        let currentColumnCollection = '';
        
        function manageColumns(collection) {
            currentColumnCollection = collection;
            document.getElementById('column-collection-name').textContent = collection;
            
            const columnList = document.getElementById('column-list');
            const columns = columnConfig[collection] || [];
            
            columnList.innerHTML = columns.map(col => `
                <div class="column-item" draggable="true" data-col="${col}">
                    <span>${col}</span>
                    <div class="flex gap-2">
                        <button onclick="removeColumn('${col}')" class="text-red-600 hover:text-red-800">Remove</button>
                    </div>
                </div>
            `).join('');

            // enable drag & drop reorder
            Array.from(columnList.querySelectorAll('.column-item')).forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.col);
                    item.classList.add('opacity-50');
                });
                item.addEventListener('dragend', e => item.classList.remove('opacity-50'));
                item.addEventListener('dragover', e => { e.preventDefault(); item.classList.add('ring-2', 'ring-indigo-300'); });
                item.addEventListener('dragleave', e => item.classList.remove('ring-2', 'ring-indigo-300'));
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    item.classList.remove('ring-2', 'ring-indigo-300');
                    const draggedCol = e.dataTransfer.getData('text/plain');
                    const targetCol = item.dataset.col;
                    if (draggedCol === targetCol) return;
                    const arr = columnConfig[currentColumnCollection];
                    const from = arr.indexOf(draggedCol);
                    const to = arr.indexOf(targetCol);
                    if (from > -1 && to > -1) {
                        arr.splice(to, 0, arr.splice(from, 1)[0]);
                        saveColumnConfig();
                        manageColumns(currentColumnCollection);
                        renderTable(currentColumnCollection);
                    }
                });
            });

            document.getElementById('column-modal').classList.add('active');
        }
        
        function addColumn() {
            const newColumnName = document.getElementById('new-column-name').value.trim();
            if (!newColumnName) {
                alert('Please enter a column name');
                return;
            }
            
            if (!columnConfig[currentColumnCollection]) {
                columnConfig[currentColumnCollection] = [];
            }
            
            if (columnConfig[currentColumnCollection].includes(newColumnName)) {
                alert('Column already exists');
                return;
            }
            
            columnConfig[currentColumnCollection].push(newColumnName);
            // ensure label mapping exists for new column
            if (!columnLabels[currentColumnCollection]) columnLabels[currentColumnCollection] = {};
            columnLabels[currentColumnCollection][newColumnName] = newColumnName;
            saveColumnLabels();
            saveColumnConfig();
            manageColumns(currentColumnCollection);
            renderTable(currentColumnCollection);
            document.getElementById('new-column-name').value = '';
        }
        
        function removeColumn(columnName) {
            if (!confirm(`Remove column "${columnName}"?`)) return;
            
            columnConfig[currentColumnCollection] = columnConfig[currentColumnCollection].filter(c => c !== columnName);
            // remove label mapping if present
            try { if (columnLabels[currentColumnCollection]) { delete columnLabels[currentColumnCollection][columnName]; saveColumnLabels(); } } catch(e) {}
            saveColumnConfig();
            manageColumns(currentColumnCollection);
            renderTable(currentColumnCollection);
        }
        
        function closeColumnModal() {
            document.getElementById('column-modal').classList.remove('active');
        }

        // Filter functions
        function filterPipeline(branch) {
            filterStates.pipeline = branch;
            document.querySelectorAll('[id^="filter-pipeline-"]').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            document.getElementById('filter-pipeline-' + branch).classList.add('active', 'bg-indigo-600', 'text-white');
            document.getElementById('filter-pipeline-' + branch).classList.remove('bg-gray-100');
            renderTable('pipeline');
        }

        function filterCandidates(status) {
            filterStates.candidates = status;
            document.querySelectorAll('[id^="filter-candidates-"]').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            document.getElementById('filter-candidates-' + status).classList.add('active', 'bg-indigo-600', 'text-white');
            document.getElementById('filter-candidates-' + status).classList.remove('bg-gray-100');
            renderTable('candidates');
        }

        // Sort table
        function sortTable(collection, field) {
            if (!sortStates[collection]) {
                sortStates[collection] = { field, direction: 'asc' };
            } else if (sortStates[collection].field === field) {
                sortStates[collection].direction = sortStates[collection].direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortStates[collection] = { field, direction: 'asc' };
            }
            
            document.querySelectorAll(`#content-${collection} th.sortable`).forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            const clickedTh = event.target.closest('th');
            clickedTh.classList.add(sortStates[collection].direction);
            
            renderTable(collection);
        }

        // Selection functions
        function toggleItemSelection(collection, id) {
            const idx = selectedItems[collection].indexOf(id);
            if (idx > -1) selectedItems[collection].splice(idx, 1);
            else selectedItems[collection].push(id);
            renderTable(collection);
        }

        function toggleRowSelection(event, collection, id) {
            const tn = (event.target && event.target.tagName) ? event.target.tagName.toUpperCase() : '';
            if (tn === 'INPUT' || tn === 'SELECT' || tn === 'BUTTON' || (event.target && event.target.type === 'checkbox')) return;
            toggleItemSelection(collection, id);
        }

        function selectAllPipeline(checked) { selectedItems.pipeline = checked ? (allData.pipeline || []).map(i => i.id) : []; renderTable('pipeline'); }
        function selectAllCandidates(checked) { selectedItems.candidates = checked ? (allData.candidates || []).map(i => i.id) : []; renderTable('candidates'); }
        function selectAllEmployers(checked) { selectedItems.employers = checked ? (allData.employers || []).map(i => i.id) : []; renderTable('employers'); }
        function selectAllPlacements(checked) { selectedItems.placements = checked ? (allData.placements || []).map(i => i.id) : []; renderTable('placements'); }
        function selectAllRisk(checked) { selectedItems.risk = checked ? (allData.risk || []).map(i => i.id) : []; renderTable('risk'); }
        function selectAllMarket(checked) { selectedItems.market = checked ? (allData.market || []).map(i => i.id) : []; renderTable('market'); }
        function selectAllTraining(checked) { selectedItems.training = checked ? (allData.training || []).map(i => i.id) : []; renderTable('training'); }

        // Bulk operations
        // Bulk edit: opens modal allowing fields to be applied to all selected items in the collection
        function bulkEditPipeline() { openBulkEditModal('pipeline'); }
        function bulkEditCandidates() { openBulkEditModal('candidates'); }
        function bulkEditEmployers() { openBulkEditModal('employers'); }
        function bulkEditPlacements() { openBulkEditModal('placements'); }
        function bulkEditRisk() { openBulkEditModal('risk'); }
        function bulkEditMarket() { openBulkEditModal('market'); }
        function bulkEditTraining() { openBulkEditModal('training'); }

        function openBulkEditModal(collection) {
            const selected = selectedItems[collection] || [];
            if (!selected || selected.length === 0) { alert('Select items'); return; }
            multiEditSelection = selected.slice();
            isBulkEdit = true;
            currentCollection = collection;
            currentDocId = '';
            document.getElementById('modal-title').textContent = `Bulk edit ${collection} (${multiEditSelection.length})`;

            const columns = columnConfig[collection] || [];
            const form = document.getElementById('edit-form');
            // Provide inputs where empty value means "no change"; only non-empty fields will be applied
            form.innerHTML = columns.map(col => `
                <label class="block mt-4">
                    <span class="text-sm font-semibold text-gray-700">${col} (leave blank = no change)</span>
                    <input type="text" name="${col}" placeholder="Set ${col} for selected...">
                </label>
            `).join('');

            document.getElementById('edit-modal').classList.add('active');
        }

        async function bulkDeletePipeline() { if (selectedItems.pipeline.length === 0) { alert('Select items'); return; } if (!confirm(`Delete ${selectedItems.pipeline.length} items?`)) return; for (const id of selectedItems.pipeline) await db.collection('pipeline').doc(id).delete(); selectedItems.pipeline = []; }
        async function bulkDeleteCandidates() { if (selectedItems.candidates.length === 0) { alert('Select items'); return; } if (!confirm(`Delete ${selectedItems.candidates.length} items?`)) return; for (const id of selectedItems.candidates) await db.collection('candidates').doc(id).delete(); selectedItems.candidates = []; }
        async function bulkDeleteEmployers() { if (selectedItems.employers.length === 0) { alert('Select items'); return; } if (!confirm(`Delete ${selectedItems.employers.length} items?`)) return; for (const id of selectedItems.employers) await db.collection('employers').doc(id).delete(); selectedItems.employers = []; }
        async function bulkDeletePlacements() { if (selectedItems.placements.length === 0) { alert('Select items'); return; } if (!confirm(`Delete ${selectedItems.placements.length} items?`)) return; for (const id of selectedItems.placements) await db.collection('placements').doc(id).delete(); selectedItems.placements = []; }
        async function bulkDeleteRisk() { if (selectedItems.risk.length === 0) { alert('Select items'); return; } if (!confirm(`Delete ${selectedItems.risk.length} items?`)) return; for (const id of selectedItems.risk) await db.collection('risk').doc(id).delete(); selectedItems.risk = []; }
        async function bulkDeleteMarket() { if (selectedItems.market.length === 0) { alert('Select items'); return; } if (!confirm(`Delete ${selectedItems.market.length} items?`)) return; for (const id of selectedItems.market) await db.collection('market').doc(id).delete(); selectedItems.market = []; }
        async function bulkDeleteTraining() { if (selectedItems.training.length === 0) { alert('Select items'); return; } if (!confirm(`Delete ${selectedItems.training.length} items?`)) return; for (const id of selectedItems.training) await db.collection('training').doc(id).delete(); selectedItems.training = []; }

        // Modal functions
        function openAddModal(collection) {
            currentCollection = collection;
            currentDocId = '';
            document.getElementById('modal-title').textContent = `Add ${collection.charAt(0).toUpperCase() + collection.slice(1)}`;
            
            const columns = columnConfig[collection] || [];
            const form = document.getElementById('edit-form');
            form.innerHTML = columns.map(col => {
                if (col === 'Stage' && collection === 'pipeline') {
                    return `
                        <label class="block mt-4">
                            <span class="text-sm font-semibold text-gray-700">Stage</span>
                            <select name="Stage">
                                <option value="Prospect">Prospect</option>
                                <option value="Contacted">Contacted</option>
                                <option value="Qualified">Qualified</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Proposal">Proposal</option>
                                <option value="Negotiation">Negotiation</option>
                                <option value="Deal Won">Deal Won</option>
                            </select>
                        </label>
                    `;
                }
                return `
                    <label class="block mt-4">
                        <span class="text-sm font-semibold text-gray-700">${col}</span>
                        <input type="text" name="${col}" placeholder="${col}">
                    </label>
                `;
            }).join('');
            
            document.getElementById('edit-modal').classList.add('active');
        }

        function editItem(collection, docId) {
            currentCollection = collection;
            currentDocId = docId;
            document.getElementById('modal-title').textContent = `Edit ${collection.charAt(0).toUpperCase() + collection.slice(1)}`;
            
            const item = allData[collection].find(i => i.id === docId);
            if (!item) return;
            
            const columns = columnConfig[collection] || [];
            const form = document.getElementById('edit-form');
            form.innerHTML = columns.map(col => {
                const value = item[col] || '';
                if (col === 'Stage' && collection === 'pipeline') {
                    return `
                        <label class="block mt-4">
                            <span class="text-sm font-semibold text-gray-700">Stage</span>
                            <select name="Stage">
                                ${['Prospect','Contacted','Qualified','Meeting','Proposal','Negotiation','Deal Won'].map(v => `<option value="${v}" ${v===value? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                        </label>
                    `;
                }
                return `
                    <label class="block mt-4">
                        <span class="text-sm font-semibold text-gray-700">${col}</span>
                        <input type="text" name="${col}" value="${value}" placeholder="${col}">
                    </label>
                `;
            }).join('');
            
            document.getElementById('edit-modal').classList.add('active');
        }

        async function saveItem(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            try {
                if (isBulkEdit && multiEditSelection.length > 0) {
                    // Apply only non-empty fields to each selected doc
                    const updateData = {};
                    Object.keys(data).forEach(k => { if (String(data[k]).trim() !== '') updateData[k] = data[k]; });
                    if (Object.keys(updateData).length === 0) { alert('No fields provided to update'); return; }
                    for (const id of multiEditSelection) {
                        await db.collection(currentCollection).doc(id).update(updateData);
                    }
                    isBulkEdit = false;
                    multiEditSelection = [];
                    selectedItems[currentCollection] = [];
                    closeModal();
                    return;
                }

                if (currentDocId) {
                    await db.collection(currentCollection).doc(currentDocId).update(data);
                } else {
                    const added = await db.collection(currentCollection).add(data);
                    // if adding to pipeline and Stage is Deal Won, promote immediately
                    if (currentCollection === 'pipeline' && data['Stage'] === 'Deal Won') {
                        openPromoteModal(added.id, data);
                    }
                }

                // If editing an existing pipeline item and Stage was set to Deal Won, open promotion
                if (currentCollection === 'pipeline' && data['Stage'] === 'Deal Won' && currentDocId) {
                    // fetch latest item
                    const doc = await db.collection('pipeline').doc(currentDocId).get();
                    if (doc.exists) openPromoteModal(currentDocId, doc.data());
                }

                closeModal();
                selectedItems[currentCollection] = [];
            } catch (error) {
                alert('Error saving: ' + error.message);
            }
        }
// Promotion flow f√ºr Candidates ‚Üí Placements (Candidate bleibt erhalten)
function openPlacementPromotionModal(candidateId, candidateData) {
    isPromotion = true;                  // reuse der bestehenden Promotion-Flag (wird im Save-Handler ausgewertet)
    promotionSourceId = candidateId;     // nur f√ºr Undo-Referenz
    promotionSavedData = Object.assign({}, candidateData); // Kopie f√ºr potentielles Undo (nicht zwingend n√∂tig, da nichts gel√∂scht wird)

    currentCollection = 'placements';
    currentDocId = '';
    document.getElementById('modal-title').textContent = 'Create Placement from Candidate';

    const columns = columnConfig.placements || ['Candidate', 'Company', 'Branch', 'Start Date', 'End Date', 'Status'];
    const form = document.getElementById('edit-form');
    form.innerHTML = columns.map(col => {
        let pre = '';
        if (col === 'Candidate') pre = candidateData.Candidate || ''; // Haupt-Prefill: Name des Candidates
        if (col === 'Branch') pre = candidateData.Branch || '';
        // weitere Prefills bei Bedarf hier erg√§nzen (z. B. German Level usw.)
        return `
            <label class="block mt-4">
                <span class="text-sm font-semibold text-gray-700">${col}</span>
                <input type="text" name="${col}" value="${escapeHtml(pre)}" placeholder="${col}">
            </label>
        `;
    }).join('');

    document.getElementById('edit-modal').classList.add('active');
}
        // Make popover draggable and persist position
        (function makePopoverDraggable(){
            const pop = document.getElementById('row-popover');
            const title = document.getElementById('row-popover-title');
            if (!pop || !title) return;
            let dragging = false;
            let startPageX = 0, startPageY = 0, startLeft = 0, startTop = 0;
            const onMouseMove = (e) => {
                if (!dragging) return;
                // use page coordinates (includes scroll) for stable dragging
                const pageX = e.pageX;
                const pageY = e.pageY;
                let left = Math.round(startLeft + (pageX - startPageX));
                let top = Math.round(startTop + (pageY - startPageY));
                const margin = 8;
                // clamp within viewport/document
                left = Math.max(margin, Math.min(left, window.innerWidth - pop.offsetWidth - margin));
                top = Math.max(window.scrollY + margin, Math.min(top, window.scrollY + window.innerHeight - pop.offsetHeight - margin));
                pop.style.left = left + 'px';
                pop.style.top = top + 'px';
            };
            title.addEventListener('mousedown', (e) => {
                e.preventDefault(); e.stopPropagation();
                dragging = true;
                document.body.style.userSelect = 'none';
                title.style.cursor = 'grabbing';
                // initialize starting positions using page coords
                startPageX = e.pageX;
                startPageY = e.pageY;
                // compute startLeft/startTop from current pop offset (parse px)
                const curLeft = parseInt(pop.style.left || 0, 10);
                const curTop = parseInt(pop.style.top || 0, 10);
                // if not set, derive from bounding rect
                startLeft = isNaN(curLeft) ? (pop.getBoundingClientRect().left + window.scrollX) : curLeft;
                startTop = isNaN(curTop) ? (pop.getBoundingClientRect().top + window.scrollY) : curTop;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            function onMouseUp(e) {
                if (!dragging) return;
                dragging = false;
                document.body.style.userSelect = '';
                title.style.cursor = 'grab';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                // save position so popover opens there next time
                try { localStorage.setItem('rowPopoverPos', JSON.stringify({ left: pop.style.left, top: pop.style.top })); } catch(e) { /*ignore*/ }
            }
            // if saved position exists apply it
            try {
                const saved = JSON.parse(localStorage.getItem('rowPopoverPos') || 'null');
                if (saved && saved.left && saved.top) {
                    pop.style.left = saved.left; pop.style.top = saved.top;
                }
            } catch(e) {}
        })();

        // Promotion flow: open modal to create employer prefilled from pipeline
        function openPromoteModal(pipelineId, pipelineData) {
            isPromotion = true;
            promotionSourceId = pipelineId;
            // save a copy in case user wants to undo the promotion
            promotionSavedData = Object.assign({}, pipelineData);
            currentCollection = 'employers';
            currentDocId = '';
            document.getElementById('modal-title').textContent = 'Promote to Employer';

            const columns = columnConfig.employers || ['Company','Branch','Trust Score','Phone','Current PowerPlus Workers','Notes'];
            const form = document.getElementById('edit-form');
            form.innerHTML = columns.map(col => {
                let pre = '';
                if (col === 'Company') pre = pipelineData.Company || pipelineData['Company'] || '';
                if (col === 'Branch') pre = pipelineData.Branch || '';
                if (col === 'Phone') pre = pipelineData.Phone || '';
                return `
                    <label class="block mt-4">
                        <span class="text-sm font-semibold text-gray-700">${col}</span>
                        <input type="text" name="${col}" value="${pre}" placeholder="${col}">
                    </label>
                `;
            }).join('');

            document.getElementById('edit-modal').classList.add('active');
        }

        // When promoting, saving should create employer and remove pipeline entry
        // Hook save action after modal submit: we reuse saveItem but handle isPromotion flag
        const originalCloseModal = closeModal;
        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
            // reset promotion/bulk flags
            isBulkEdit = false;
            multiEditSelection = [];
            isPromotion = false;
            promotionSourceId = '';
        }

// Intercept form submit to handle BOTH promotion flows
document.getElementById('edit-form').addEventListener('submit', async function(e) {
    if (!isPromotion) return; // normale Saves gehen an saveItem()
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {};
    formData.forEach((v,k) => data[k]=v);

    try {
        // Neuen Eintrag erstellen (employers oder placements)
        const res = await db.collection(currentCollection).add(data);
        const newId = res.id;

        // NUR bei Pipeline‚ÜíEmployer: altes Pipeline-Item l√∂schen
        if (currentCollection === 'employers' && promotionSourceId) {
            await db.collection('pipeline').doc(promotionSourceId).delete();
        }
        // Bei Candidates‚ÜíPlacements: nichts l√∂schen ‚Üí Candidate bleibt

        showSnackbar(
            currentCollection === 'employers' ? 'Employer erstellt & Pipeline-Item entfernt' : 'Placement erstellt',
            8000,
            async () => {
                try {
                    await db.collection(currentCollection).doc(newId).delete();
                    // Nur bei Pipeline-Promotion wiederherstellen
                    if (currentCollection === 'employers' && promotionSourceId && promotionSavedData) {
                        await db.collection('pipeline').doc(promotionSourceId).set(promotionSavedData);
                    }
                } catch (undoErr) {
                    console.error('Undo failed', undoErr);
                    alert('Undo fehlgeschlagen: ' + undoErr.message);
                } finally {
                    promotionSourceId = '';
                    promotionSavedData = null;
                    isPromotion = false;
                }
            }
        );

        closeModal();
        selectedItems[currentCollection] = [];
    } catch (err) {
        alert('Fehler beim Erstellen: ' + err.message);
    }
});

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            document.getElementById('content-' + tabName).classList.remove('hidden');
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('active', 'bg-indigo-600', 'text-white');
            activeBtn.classList.remove('bg-gray-100');
        }

        // Initialize
        window.onload = () => {
            loadAllCollections();
            switchTab('overview');
            // initialize placements chart toggle UI
            setTimeout(() => { try { togglePlacementsChart(placementsChartType); } catch(e){} }, 300);
        };
    </script>
</body>
</html>
