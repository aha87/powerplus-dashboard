<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerPlus Dashboard - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <style>
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .filter-btn { transition: all 0.2s; cursor: pointer; }
        .filter-btn.active { background: #6366f1; color: white; }
        .badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-blue { background: #dbeafe; color: #1d4ed8; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-purple { background: #ede9fe; color: #5b21b6; }
        
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 9999px; overflow: hidden; width: 120px; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #10b981, #34d399); transition: width 0.5s ease-in-out; }
        
        .trust-score { padding: 4px 12px; border-radius: 9999px; font-weight: 600; display: inline-block; }
        .trust-1 { background: #fee2e2; color: #991b1b; }
        .trust-2 { background: #fed7aa; color: #9a3412; }
        .trust-3 { background: #fef3c7; color: #92400e; }
        .trust-4 { background: #d1fae5; color: #065f46; }
        .trust-5 { background: #a7f3d0; color: #064e3b; }
        
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #f3f4f6; }
        .sort-arrow { display: inline-block; margin-left: 4px; opacity: 0.3; }
        .sortable.asc .sort-arrow { opacity: 1; transform: rotate(0deg); }
        .sortable.desc .sort-arrow { opacity: 1; transform: rotate(180deg); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 1rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; }
        
        input, select, textarea { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; margin-top: 0.5rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #6366f1; }
        textarea { min-height: 80px; }
        
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(99,102,241,0.3); }
        .btn-secondary { background: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-danger { background: #ef4444; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
        .btn-danger:hover { background: #dc2626; }
        .btn-edit { background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-edit:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; margin-left: 0.5rem; }
        .btn-success:hover { background: #059669; }
        
        .action-bar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .column-list { max-height: 300px; overflow-y: auto; }
        .column-item { padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .column-item.dragging { opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-50">

<!-- Header + Tabs + Content bleibt exakt wie in deinem Code -->

<script>
    // Firestore & Dashboard Logic (basierend auf deinem funktionierenden Code)
    const firebaseConfig = {
        apiKey: "AIzaSyA1WKOUlVF1YvBMolSVACHOXz2kGQ_a6Sc",
        authDomain: "powerplus-dashboard.firebaseapp.com",
        projectId: "powerplus-dashboard",
        storageBucket: "powerplus-dashboard.firebasestorage.app",
        messagingSenderId: "506858654374",
        appId: "1:506858654374:web:06e47ff0cd5f8ae7808267",
        measurementId: "G-H1BJQBB3KP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let allData = {};
    let sortStates = {};
    let filterStates = { pipeline: 'all', candidates: 'all' };
    let selectedItems = { pipeline: [], candidates: [], employers: [], placements: [], risk: [], market: [], training: [] };
    let charts = {};
    let chartsInitialized = false;

    // Column config & Drag-and-Drop
    let columnConfig = {
        pipeline: ['Company','Branch','Region','Stage','Priority','Azubi Bedarf','Phone','Last Contacted'],
        candidates: ['Name','Branch','German Level','Overall Score','Status','Training Progress'],
        employers: ['Company','Branch','Trust Score','Phone','Current PowerPlus Workers','Notes'],
        placements: ['Candidate','Company','Branch','Start Date','End Date','Status'],
        risk: ['Item','Type','Risk Level','Status'],
        market: ['Branch','Vacancy Rate','Regional Demand','Priority Score'],
        training: ['Module','Type','Duration','Status']
    };

    const savedConfig = localStorage.getItem('columnConfig');
    if(savedConfig) columnConfig = JSON.parse(savedConfig);
    function saveColumnConfig(){ localStorage.setItem('columnConfig', JSON.stringify(columnConfig)); }

    function initDragAndDrop(){ 
        const list = document.getElementById('column-list');
        let dragSrcEl = null;
        list.addEventListener('dragstart', e => { if(e.target.classList.contains('column-item')) { dragSrcEl = e.target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', e.target.outerHTML); e.target.classList.add('dragging'); } });
        list.addEventListener('dragend', e => { if(e.target.classList.contains('column-item')) e.target.classList.remove('dragging'); });
        list.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
        list.addEventListener('drop', e => {
            e.preventDefault();
            if(e.target.classList.contains('column-item')) {
                const dropHTML = e.dataTransfer.getData('text/html');
                dragSrcEl.outerHTML = e.target.outerHTML;
                e.target.outerHTML = dropHTML;
                updateColumnOrder();
                initDragAndDrop();
            }
        });
    }

    function updateColumnOrder(){
        const list = document.getElementById('column-list');
        const items = Array.from(list.children).map(el => el.querySelector('span').textContent);
        columnConfig[currentColumnCollection] = items;
        saveColumnConfig();
        renderTable(currentColumnCollection);
    }

    let currentColumnCollection = '';
    function manageColumns(collection){
        currentColumnCollection = collection;
        document.getElementById('column-collection-name').textContent = collection;
        const columnList = document.getElementById('column-list');
        columnList.innerHTML = columnConfig[collection].map(col => `<div class="column-item" draggable="true"><span>${col}</span><button onclick="removeColumn('${col}')" class="text-red-600 hover:text-red-800">Remove</button></div>`).join('');
        document.getElementById('column-modal').classList.add('active');
        initDragAndDrop();
    }

    function removeColumn(col){
        columnConfig[currentColumnCollection] = columnConfig[currentColumnCollection].filter(c => c!==col);
        saveColumnConfig();
        manageColumns(currentColumnCollection);
    }

    function addColumn(){
        const newCol = document.getElementById('new-column-name').value.trim();
        if(!newCol){ alert('Enter column name'); return; }
        if(columnConfig[currentColumnCollection].includes(newCol)){ alert('Column exists'); return; }
        columnConfig[currentColumnCollection].push(newCol);
        saveColumnConfig();
        manageColumns(currentColumnCollection);
        document.getElementById('new-column-name').value='';
    }

    function closeColumnModal(){ document.getElementById('column-modal').classList.remove('active'); }

    // Restliche Dashboard-Logik: loadAllCollections(), renderTable(), updateMetrics(), updateCharts() bleibt exakt wie in deinem funktionierenden Code

    loadAllCollections(); // Startet alles
</script>

</body>
</html>
